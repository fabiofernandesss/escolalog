<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema Escolar</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sistema Escolar">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="../img/favicon.png">
    <link rel="shortcut icon" type="image/png" href="../img/favicon.png">
    <link rel="apple-touch-icon" href="../img/metatag.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="../manifest.json">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <link rel="stylesheet" href="../css/pwa-styles.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
            padding: 16px 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 48px;
            max-width: 100%;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .user-info:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .back-btn {
            width: 38px;
            height: 38px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .back-btn i { width: 20px; height: 20px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .stat-card .icon {
            width: 38px;
            height: 38px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563eb;
        }

        .stat-number { font-size: 1.6rem; font-weight: 700; color: #1e293b; }
        .stat-label { font-size: 0.85rem; color: #64748b; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden; /* evita overflow do canvas em redimensionamentos */
        }

        .chart-title { font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 8px; }
        .chart-canvas { width: 100%; height: 280px; display: block; }
        .chart-card.chart-square .chart-canvas { aspect-ratio: 1 / 1; height: auto; }

        .recent-students {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .recent-students h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }

        /* Filtros de logs */
        .logs-filters {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        .filter-row {
            display: flex;
            gap: 16px;
            align-items: end;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 200px;
        }
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn-clear {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-clear:hover {
            background: #dc2626;
        }

        /* Lista de logs em layout lateral */
        .student-list { 
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .student-item { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 16px; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            background: #ffffff;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .student-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .student-avatar { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background: #3b82f6; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
            font-size: 1.2rem; 
            border: 3px solid #e2e8f0; 
            object-fit: cover;
            flex-shrink: 0;
        }
        .student-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .student-name { 
            font-size: 1rem; 
            font-weight: 600; 
            color: #1e293b; 
            margin-bottom: 4px;
        }
        .student-details { 
            font-size: 0.875rem; 
            color: #64748b; 
        }
        .student-details div {
            margin-bottom: 2px;
        }
        .student-details strong {
            color: #374151;
        }

        /* Loading indicator para scroll infinito */
        .loading-more {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            color: #64748b;
            font-size: 0.875rem;
        }

        .loading { display: flex; align-items: center; gap: 8px; color: #64748b; }
        .spinner { width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .header { flex-direction: row; gap: 8px; padding: 12px 16px; align-items: center; }
            .logo img { height: 32px; flex-shrink: 0; }
            .user-avatar { width: 32px; height: 32px; font-size: 14px; }
            .stat-number { font-size: 1.3rem; }
            .stat-label { font-size: 0.8rem; }
            .chart-canvas { height: 200px; }
            .chart-card.chart-square .chart-canvas { aspect-ratio: 1 / 1; height: auto; }
            /* Tr√™s colunas para cards de m√©tricas no mobile */
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .stat-card { padding: 10px; }
            .stat-card .icon { width: 28px; height: 28px; }
            .stat-number { font-size: 1.1rem; }
            .stat-label { font-size: 0.7rem; }
            .student-avatar { width: 44px; height: 44px; }
        }

        /* Para dispositivos muito pequenos, manter 3 colunas mas com ajustes */
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 4px; }
            .stat-card { padding: 8px; }
            .stat-card .icon { width: 24px; height: 24px; }
            .stat-number { font-size: 1rem; }
            .stat-label { font-size: 0.65rem; line-height: 1.2; }
        }

        /* Para dispositivos extremamente pequenos */
        @media (max-width: 360px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 3px; }
            .stat-card { padding: 6px; }
            .stat-card .icon { width: 20px; height: 20px; }
            .stat-number { font-size: 0.9rem; }
            .stat-label { font-size: 0.6rem; line-height: 1.1; }
        }
    </style>
    <style>
        /* Mobile readability boost (no header changes) */
        @media (max-width: 768px) {
            body { font-size: 16px; }
            .stat-number { font-size: 1.35rem; }
            .stat-label { font-size: 0.85rem; }
            .chart-title { font-size: 1.05rem; }
            .student-name { font-size: 0.95rem; }
            .student-details { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo" onclick="window.location.href='menu.html'" style="cursor: pointer;">
                    <img src="../img/logo-horizonal.png" alt="Escola Log">
                </div>
            </div>
            <div class="header-right">
                <a href="menu.html" class="back-btn" aria-label="Voltar">
                    <i data-lucide="chevron-left"></i>
                </a>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card total">
                <div class="icon">
                    <i data-lucide="users"></i>
                </div>
                <div class="stat-number" id="totalStudents">-</div>
                <div class="stat-label">Total de Alunos</div>
            </div>

            <div class="stat-card male">
                <div class="icon">
                    <i data-lucide="user"></i>
                </div>
                <div class="stat-number" id="maleStudents">-</div>
                <div class="stat-label">Masculinos</div>
            </div>

            <div class="stat-card female">
                <div class="icon">
                    <i data-lucide="user"></i>
                </div>
                <div class="stat-number" id="femaleStudents">-</div>
                <div class="stat-label">Femininos</div>
            </div>

            <div class="stat-card">
                <div class="icon">
                    <i data-lucide="help-circle"></i>
                </div>
                <div class="stat-number" id="unknownStudents">-</div>
                <div class="stat-label">N√£o Informado</div>
            </div>

            <div class="stat-card schools">
                <div class="icon">
                    <i data-lucide="users"></i>
                </div>
                <div class="stat-number" id="totalClasses">-</div>
                <div class="stat-label">Minhas Turmas</div>
            </div>



            <div class="stat-card">
                <div class="icon">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="stat-number" id="presentToday">-</div>
                <div class="stat-label">Presentes Hoje</div>
            </div>

            <div class="stat-card">
                <div class="icon">
                    <i data-lucide="x-circle"></i>
                </div>
                <div class="stat-number" id="absentToday">-</div>
                <div class="stat-label">Faltas Hoje</div>
            </div>

            <div class="stat-card">
                <div class="icon">
                    <i data-lucide="trending-up"></i>
                </div>
                <div class="stat-number" id="attendanceRate">-</div>
                <div class="stat-label">Taxa de Presen√ßa</div>
            </div>

            <div class="stat-card">
                <div class="icon">
                    <i data-lucide="clock"></i>
                </div>
                <div class="stat-number" id="avgTimeInSchool">-</div>
                <div class="stat-label">Tempo M√©dio na Escola</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card chart-square">
                <h3 class="chart-title">Distribui√ß√£o por G√™nero</h3>
                <div id="genderChart" class="chart-canvas"></div>
            </div>

            <div class="chart-card">
                <h3 class="chart-title">Alunos por S√©rie</h3>
                <div id="seriesChart" class="chart-canvas"></div>
            </div>

            <div class="chart-card">
                <h3 class="chart-title">Alunos por Turma</h3>
                <div id="classChart" class="chart-canvas"></div>
            </div>

            <div class="chart-card chart-square">
                <h3 class="chart-title">Distribui√ß√£o por Bairro</h3>
                <div id="neighborhoodChart" class="chart-canvas"></div>
            </div>
        </div>

        <div class="recent-students">
             <h3>
                 <i data-lucide="activity"></i>
                 Logs Recentes da Escola
             </h3>
             
             <!-- Filtros -->
             <div class="logs-filters">
                 <div class="filter-row">
                     <div class="filter-group">
                         <label for="searchStudent">Pesquisar Aluno:</label>
                         <input type="text" id="searchStudent" placeholder="Digite o nome do aluno..." />
                     </div>
                     <div class="filter-group">
                         <label for="dateFilter">Filtrar por Data:</label>
                         <input type="date" id="dateFilter" />
                     </div>
                     <div class="filter-group">
                         <button id="clearFilters" class="btn-clear">Limpar Filtros</button>
                     </div>
                 </div>
             </div>
             
             <div class="student-list" id="recentStudents">
                <div class="loading">
                    <div class="spinner"></div>
                    Carregando logs...
                </div>
            </div>
            
            <!-- Loading indicator para scroll infinito -->
            <div id="loadingMore" class="loading-more" style="display: none;">
                <div class="spinner"></div>
                Carregando mais logs...
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o Supabase (busca via Lambda com fallback)
        let supabase = null;

        async function getSupabaseKeys() {
            try {
                const response = await fetch('https://yfh5dmsuucx76bronca7f7k3le0sjykd.lambda-url.us-east-2.on.aws/', {
                    method: 'GET', headers: { 'Content-Type': 'application/json' }, mode: 'cors'
                });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (data.status === 'success' && data.data) {
                    return {
                        url: data.data.SUPABASE_URL1?.trim() || data.data.SUPABASE_URL,
                        key: data.data.SUPABASE_KEY1?.trim() || data.data.SUPABASE_KEY
                    };
                }
                throw new Error('Formato inv√°lido');
            } catch (error) {
                return {
                    url: 'https://sntyndufbxfzasnqvayc.supabase.co',
                    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNudHluZHVmYnhmemFzbnF2YXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzQ2ODcsImV4cCI6MjA3MTc1MDY4N30.Pv9CaNkpo2HMMAtPbyLz2AdR8ZyK1jtHbP78pR5CPSM'
                };
            }
        }

        async function initializeSupabase() {
            const keys = await getSupabaseKeys();
            supabase = window.supabase.createClient(keys.url, keys.key);
        }

        let currentUser = null;
        let turmas = [];
        let turmaIds = [];
        let logsSubscription = null; // Para subscription em tempo real
        let dashboardData = {
            totalStudents: 0,
            maleStudents: 0,
            femaleStudents: 0,
            unknownGender: 0,
            totalSchools: 0,
            genderData: [],
            seriesData: [],
            classData: [],
            neighborhoodData: [],
            recentLogs: [] // Mudan√ßa: logs ao inv√©s de students
        };

        // Verificar autentica√ß√£o (alinha com menu: usa whatsapp_user)
        function checkAuth() {
            try {
                currentUser = JSON.parse(localStorage.getItem('whatsapp_user')) 
                    || JSON.parse(localStorage.getItem('currentUser'));

                if (!currentUser) {
                    window.location.href = '../login.html';
                    return false;
                }

                // Checar perfil do usu√°rio
                if (currentUser.tipo_usuario && currentUser.tipo_usuario !== 'professor') {
                    // Redireciona por tipo (mant√©m consist√™ncia com menu)
                    switch(currentUser.tipo_usuario) {
                        case 'admin':
                            window.location.href = '../admin/dashboard.html';
                            break;
                        case 'diretor':
                            window.location.href = '../diretor/menu.html';
                            break;
                        case 'responsavel':
                            window.location.href = '../responsavel/menu.html';
                            break;
                        default:
                            window.location.href = '../login.html';
                    }
                    return false;
                }

                // Atualizar avatar do usu√°rio
                const userAvatar = document.getElementById('userAvatar');
                const nome = currentUser.nome || currentUser.name || '';
                if (userAvatar && nome) {
                    userAvatar.textContent = nome.charAt(0).toUpperCase();
                }

                return true;
            } catch (e) {
                console.error('Erro na verifica√ß√£o de autentica√ß√£o do dashboard:', e);
                window.location.href = '../login.html';
                return false;
            }
        }

        // Carregar todos os logs em tempo real da frequ√™ncia di√°ria
        // Vari√°veis para controle de pagina√ß√£o e filtros
        let currentPage = 0;
        const pageSize = 20;
        let isLoading = false;
        let hasMoreLogs = true;
        let currentFilters = {
            studentName: '',
            dateFrom: '',
            dateTo: ''
        };

        async function loadRecentLogs(reset = false) {
            if (isLoading || (!hasMoreLogs && !reset)) return;
            
            try {
                isLoading = true;
                
                if (reset) {
                    currentPage = 0;
                    hasMoreLogs = true;
                    dashboardData.recentLogs = [];
                }

                // Construir query com filtros
                let query = supabase
                    .from('frequencia_diaria')
                    .select(`
                        nome_aluno,
                        url_foto_aluno,
                        entrada,
                        saida,
                        turma_nome,
                        serie_nome,
                        escola_nome,
                        total_logs,
                        tipo_frequencia,
                        tempo_na_escola_formatado
                    `)
                    .not('nome_aluno', 'is', null);

                // Aplicar filtro de nome do aluno
                if (currentFilters.studentName) {
                    query = query.ilike('nome_aluno', `%${currentFilters.studentName}%`);
                }

                // Aplicar filtro de data
                if (currentFilters.dateFrom) {
                    query = query.gte('entrada', currentFilters.dateFrom);
                }
                if (currentFilters.dateTo) {
                    const dateTo = new Date(currentFilters.dateTo);
                    dateTo.setHours(23, 59, 59, 999);
                    query = query.lte('entrada', dateTo.toISOString());
                }

                // Aplicar pagina√ß√£o
                const from = currentPage * pageSize;
                const to = from + pageSize - 1;
                
                query = query
                    .order('entrada', { ascending: false })
                    .range(from, to);

                const { data: logs, error } = await query;

                if (error) {
                    console.error('Erro ao carregar logs:', error);
                    return;
                }

                const newLogs = logs || [];
                
                if (reset) {
                    dashboardData.recentLogs = newLogs;
                } else {
                    dashboardData.recentLogs = [...dashboardData.recentLogs, ...newLogs];
                }

                hasMoreLogs = newLogs.length === pageSize;
                currentPage++;

                renderRecentLogs(reset);
            } catch (error) {
                console.error('Erro ao carregar logs recentes:', error);
            } finally {
                isLoading = false;
            }
        }

        // Renderizar lista de logs com scroll infinito
        function renderRecentLogs(reset = false) {
            const container = document.getElementById('recentStudents');
            
            if (dashboardData.recentLogs.length === 0) {
                container.innerHTML = '<div class="loading">Nenhum log encontrado</div>';
                return;
            }

            // Atualizar t√≠tulo da se√ß√£o
            const titleElement = document.querySelector('#recentStudents').previousElementSibling;
            if (titleElement && titleElement.tagName === 'H3') {
                titleElement.textContent = `√öltimos Logs em Tempo Real (${dashboardData.recentLogs.length}${hasMoreLogs ? '+' : ''})`;
            }

            const logsHtml = dashboardData.recentLogs.map(log => {
                // Formatar hor√°rio de entrada - os dados j√° est√£o no hor√°rio local brasileiro
                // mas s√£o marcados como UTC, ent√£o vamos interpretar como hor√°rio local
                const entrada = log.entrada ? (() => {
                    const date = new Date(log.entrada);
                    // Adicionar 3 horas para compensar a diferen√ßa UTC-3
                    date.setHours(date.getHours() + 3);
                    return date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                })() : 'Sem hor√°rio';

                // Formatar hor√°rio de sa√≠da se existir
                const saida = log.saida && log.saida !== log.entrada ? (() => {
                    const date = new Date(log.saida);
                    // Adicionar 3 horas para compensar a diferen√ßa UTC-3
                    date.setHours(date.getHours() + 3);
                    return date.toLocaleString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                })() : null;

                return `
                    <div class="student-item">
                        ${log.url_foto_aluno 
                            ? `<img src="${log.url_foto_aluno}" alt="${log.nome_aluno}" class="student-avatar">`
                            : `<div class="student-avatar">${(log.nome_aluno || 'A').charAt(0).toUpperCase()}</div>`
                        }
                        <div class="student-info">
                            <div class="student-name">${log.nome_aluno || 'Aluno n√£o identificado'}</div>
                            <div class="student-details">
                                <div>${log.turma_nome || 'Sem turma'} ‚Ä¢ ${log.serie_nome || 'Sem s√©rie'}</div>
                                <div><strong>Entrada:</strong> ${entrada}</div>
                                ${saida ? `<div><strong>Sa√≠da:</strong> ${saida}</div>` : ''}
                                <div><strong>Logs:</strong> ${log.total_logs || 0} ‚Ä¢ <strong>Tipo:</strong> ${log.tipo_frequencia || 'N/A'}</div>
                                ${log.tempo_na_escola_formatado ? `<div><strong>Tempo na escola:</strong> ${log.tempo_na_escola_formatado}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Adicionar indicador de loading se h√° mais logs
            const loadingIndicator = hasMoreLogs ? 
                '<div class="loading-more" id="loadingMore">üîÑ Carregando mais logs...</div>' : '';

            container.innerHTML = logsHtml + loadingIndicator;

            // Configurar scroll infinito
            setupInfiniteScroll();
        }

        // Configurar scroll infinito
        function setupInfiniteScroll() {
            const container = document.querySelector('.student-list');
            const loadingIndicator = document.getElementById('loadingMore');
            
            if (!container || !loadingIndicator) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && hasMoreLogs && !isLoading) {
                        loadRecentLogs(false);
                    }
                });
            }, {
                root: container,
                rootMargin: '100px'
            });

            observer.observe(loadingIndicator);
        }

        // Aplicar filtros
        function applyFilters() {
            const studentNameInput = document.getElementById('studentSearch');
            const dateFromInput = document.getElementById('dateFrom');
            const dateToInput = document.getElementById('dateTo');

            currentFilters = {
                studentName: studentNameInput?.value.trim() || '',
                dateFrom: dateFromInput?.value || '',
                dateTo: dateToInput?.value || ''
            };

            loadRecentLogs(true);
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('studentSearch').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            currentFilters = {
                studentName: '',
                dateFrom: '',
                dateTo: ''
            };

            loadRecentLogs(true);
        }

        // Configurar subscription em tempo real para frequ√™ncia di√°ria
        function setupLogsSubscription() {
            // Remover subscription anterior se existir
            if (logsSubscription) {
                supabase.removeChannel(logsSubscription);
            }

            // Criar nova subscription para frequencia_diaria
            logsSubscription = supabase
                .channel('frequencia-realtime')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'frequencia_diaria'
                }, (payload) => {
                    console.log('üîÑ Nova frequ√™ncia recebida:', payload.new);
                    // Recarregar logs quando houver inser√ß√£o (reset para mostrar novos logs no topo)
                    loadRecentLogs(true);
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'frequencia_diaria'
                }, (payload) => {
                    console.log('üîÑ Frequ√™ncia atualizada:', payload.new);
                    // Recarregar logs quando houver atualiza√ß√£o (reset para mostrar atualiza√ß√µes)
                    loadRecentLogs(true);
                })
                .subscribe((status) => {
                    console.log('üì° Status da subscription de frequ√™ncia:', status);
                });
        }

        // Carregar dados do dashboard
        async function loadDashboardData() {
            try {
                // Carregar turmas com permiss√£o para este professor
                await loadProfessorTurmas();
                // Carregar estat√≠sticas b√°sicas
                await loadBasicStats();
                
                // Carregar dados para gr√°ficos
                await loadChartData();
                
                // Carregar logs recentes (substituindo alunos recentes)
                await loadRecentLogs();
                
                // Configurar subscription em tempo real
                setupLogsSubscription();
                
                // Renderizar gr√°ficos
                renderCharts();
                
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }

        // Carregar turmas permitidas do professor
        async function loadProfessorTurmas() {
            try {
                if (!currentUser || !currentUser.id) return;

                // Turmas onde o professor √© respons√°vel
                const { data: turmasResp } = await supabase
                    .from('turmas')
                    .select('id, nome, serie_id')
                    .eq('professor_responsavel_id', currentUser.id)
                    .eq('soft_delete', false);

                // Permiss√µes expl√≠citas de turmas
                const { data: perms } = await supabase
                    .from('permissoes')
                    .select('referencia_id')
                    .eq('usuario_id', currentUser.id)
                    .eq('tipo', 'turma')
                    .eq('ativo', true);

                const permTurmaIds = (perms || []).map(p => p.referencia_id).filter(Boolean);
                let turmasPerm = [];
                if (permTurmaIds.length > 0) {
                    const { data: turmasData } = await supabase
                        .from('turmas')
                        .select('id, nome, serie_id')
                        .in('id', permTurmaIds)
                        .eq('soft_delete', false);
                    turmasPerm = turmasData || [];
                }

                const todas = [...(turmasResp || []), ...turmasPerm];
                const unicas = [];
                const seen = new Set();
                for (const t of todas) { if (!seen.has(t.id)) { seen.add(t.id); unicas.push(t); } }
                turmas = unicas;
                turmaIds = unicas.map(t => t.id);
            } catch (_) {
                turmas = [];
                turmaIds = [];
            }
        }

        // Carregar estat√≠sticas b√°sicas
        async function loadBasicStats() {
            // Verificar se h√° turmas permitidas
            if (!turmaIds.length) {
                // Se n√£o h√° turmas, definir todos os valores como 0
                dashboardData.totalStudents = 0;
                dashboardData.maleStudents = 0;
                dashboardData.femaleStudents = 0;
                dashboardData.totalClasses = 0;
            } else {
                // Total de alunos (apenas das turmas permitidas)
                const { data: students, error: studentsError } = await supabase
                    .from('alunos')
                    .select('id, sexo')
                    .is('soft_delete', false)
                    .in('turma_id', turmaIds);

                if (studentsError) {
                    console.error('Erro Supabase (alunos b√°sicos):', studentsError);
                    dashboardData.totalStudents = 0;
                    dashboardData.maleStudents = 0;
                    dashboardData.femaleStudents = 0;
                } else if (students) {
                    dashboardData.totalStudents = students.length;
                    const genderCounts = { male: 0, female: 0, unknown: 0 };
                    (students || []).forEach(s => {
                        const sex = (s.sexo || '').toString().trim().toLowerCase();
                        if (sex === 'm' || sex === 'masculino') genderCounts.male++;
                        else if (sex === 'f' || sex === 'feminino') genderCounts.female++;
                        else genderCounts.unknown++;
                    });
                    dashboardData.maleStudents = genderCounts.male;
                    dashboardData.femaleStudents = genderCounts.female;
                    dashboardData.unknownGender = genderCounts.unknown;
                } else {
                    dashboardData.totalStudents = 0;
                    dashboardData.maleStudents = 0;
                    dashboardData.femaleStudents = 0;
                }

                // Total de turmas do professor
                dashboardData.totalClasses = turmas.length;
            }

            // Carregar estat√≠sticas de frequ√™ncia
            await loadFrequencyStats();

            // Atualizar UI
            document.getElementById('totalStudents').textContent = dashboardData.totalStudents || 0;
            document.getElementById('maleStudents').textContent = dashboardData.maleStudents || 0;
            document.getElementById('femaleStudents').textContent = dashboardData.femaleStudents || 0;
            const unknownEl = document.getElementById('unknownStudents');
            if (unknownEl) { unknownEl.textContent = dashboardData.unknownGender || 0; }
            document.getElementById('totalClasses').textContent = dashboardData.totalClasses || 0;
        }

        // Carregar estat√≠sticas de frequ√™ncia
        async function loadFrequencyStats() {
            try {
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const todayEnd = new Date();
                todayEnd.setHours(23, 59, 59, 999);

                // Presentes hoje via logs (alunos com alguma "entrada" hoje nas turmas do professor)
                const { data: presentLogs, error: presentLogsError } = await supabase
                    .from('logs')
                    .select('internal_id, event, data_do_log, turma_id')
                    .in('turma_id', turmaIds.length ? turmaIds : [-1])
                    .not('internal_id', 'is', null)
                    .gte('data_do_log', todayStart.toISOString())
                    .lte('data_do_log', todayEnd.toISOString())
                    .eq('event', 7);

                if (presentLogsError) {
                    console.error('Erro ao carregar logs de entrada hoje:', presentLogsError);
                    dashboardData.presentToday = 0;
                } else {
                    const uniquePresentIds = new Set((presentLogs || []).map(l => l.internal_id).filter(Boolean));
                    dashboardData.presentToday = uniquePresentIds.size;
                }

                const totalStudentsToday = dashboardData.totalStudents || 0;
                dashboardData.absentToday = Math.max(0, totalStudentsToday - (dashboardData.presentToday || 0));
                


                // Calcular taxa de presen√ßa (hoje) com base em logs
                dashboardData.attendanceRate = totalStudentsToday > 0
                    ? Math.round(((dashboardData.presentToday || 0) / totalStudentsToday) * 100)
                    : 0;

                // Refer√™ncia de 30 dias para c√°lculo de tempo m√©dio na escola
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

                // Tempo m√©dio na escola (√∫ltimos 30 dias)
                const { data: timeRecords, error: timeError } = await supabase
                    .from('frequencia_diaria')
                    .select('horas_na_escola')
                    .in('turma_id', turmaIds.length ? turmaIds : [-1])
                    .gte('dia', thirtyDaysAgoStr)
                    .not('horas_na_escola', 'is', null);

                if (timeError) {
                    console.error('Erro ao carregar tempo na escola:', timeError);
                    dashboardData.averageTimeInSchool = '0h 0m';
                } else {
                    const validTimes = timeRecords?.filter(r => r.horas_na_escola > 0) || [];
                    if (validTimes.length > 0) {
                        const totalHours = validTimes.reduce((sum, r) => sum + r.horas_na_escola, 0);
                        const averageHours = totalHours / validTimes.length;
                        const hours = Math.floor(averageHours);
                        const minutes = Math.round((averageHours - hours) * 60);
                        dashboardData.averageTimeInSchool = `${hours}h ${minutes}m`;
                    } else {
                        dashboardData.averageTimeInSchool = '0h 0m';
                    }
                }

                // Atualizar UI das novas estat√≠sticas
                document.getElementById('presentToday').textContent = dashboardData.presentToday;
                document.getElementById('absentToday').textContent = dashboardData.absentToday;
                document.getElementById('attendanceRate').textContent = `${dashboardData.attendanceRate}%`;
                document.getElementById('avgTimeInSchool').textContent = dashboardData.averageTimeInSchool;

            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas de frequ√™ncia:', error);
                // Definir valores padr√£o em caso de erro
                dashboardData.presentToday = 0;
                dashboardData.absentToday = 0;
                dashboardData.attendanceRate = 0;
                dashboardData.averageTimeInSchool = '0h 0m';
                
                document.getElementById('presentToday').textContent = '0';
                document.getElementById('absentToday').textContent = '0';
                document.getElementById('attendanceRate').textContent = '0%';
                document.getElementById('avgTimeInSchool').textContent = '0h 0m';
            }
        }

        // Carregar dados para gr√°ficos
        async function loadChartData() {
            try {
                if (!turmaIds || turmaIds.length === 0) {
                    // Se n√£o h√° turmas, definir dados vazios
                    dashboardData.seriesData = [];
                    dashboardData.classData = [];
                    dashboardData.neighborhoodData = [];
                    return;
                }

                // Carregar dados de alunos das turmas do professor
                const { data: students, error: studentsError } = await supabase
                    .from('alunos')
                    .select(`
                        id,
                        nome,
                        bairro,
                        turma_id,
                        turmas!inner(nome, serie_id),
                        series!inner(nome)
                    `)
                    .in('turma_id', turmaIds)
                    .eq('soft_delete', false);

                if (studentsError) {
                    console.error('Erro ao carregar dados para gr√°ficos:', studentsError);
                    dashboardData.seriesData = [];
                    dashboardData.classData = [];
                    dashboardData.neighborhoodData = [];
                    return;
                }

                // Processar dados por s√©rie
                const seriesCount = {};
                const classCount = {};
                const neighborhoodCount = {};

                (students || []).forEach(student => {
                    // Contar por s√©rie
                    const serieName = student.series?.nome || 'Sem s√©rie';
                    seriesCount[serieName] = (seriesCount[serieName] || 0) + 1;

                    // Contar por turma
                    const className = student.turmas?.nome || 'Sem turma';
                    classCount[className] = (classCount[className] || 0) + 1;

                    // Contar por bairro
                    if (student.bairro && student.bairro.trim()) {
                        const neighborhood = student.bairro.trim();
                        neighborhoodCount[neighborhood] = (neighborhoodCount[neighborhood] || 0) + 1;
                    }
                });

                // Converter para formato de array [nome, quantidade]
                dashboardData.seriesData = Object.entries(seriesCount)
                    .sort((a, b) => b[1] - a[1]) // Ordenar por quantidade decrescente
                    .slice(0, 10); // Limitar a 10 itens

                dashboardData.classData = Object.entries(classCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                dashboardData.neighborhoodData = Object.entries(neighborhoodCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

            } catch (error) {
                console.error('Erro ao carregar dados dos gr√°ficos:', error);
                dashboardData.seriesData = [];
                dashboardData.classData = [];
                dashboardData.neighborhoodData = [];
            }
        }

        // Renderizar gr√°ficos com ApexCharts
        function renderCharts() {
            // G√™nero (donut)
            const genderOptions = {
                chart: { type: 'donut', height: 280 },
                series: [
                    dashboardData.maleStudents || 0,
                    dashboardData.femaleStudents || 0,
                    dashboardData.unknownGender || 0
                ],
                labels: ['Masculinos', 'Femininos', 'N√£o Informado'],
                colors: ['#4FACFE', '#FA709A', '#A0AEC0'],
                legend: { position: 'bottom' },
                dataLabels: { enabled: true },
                responsive: [{ breakpoint: 640, options: { chart: { height: 200 }, legend: { position: 'bottom' } } }]
            };
            const genderChart = new ApexCharts(document.querySelector('#genderChart'), genderOptions);
            genderChart.render();

            // S√©ries (bar)
            const seriesLabels = (dashboardData.seriesData || []).map(i => i[0]);
            const seriesValues = (dashboardData.seriesData || []).map(i => i[1]);
            const seriesOptions = {
                chart: { type: 'bar', height: 280 },
                series: [{ name: 'Alunos', data: seriesValues }],
                xaxis: { categories: seriesLabels },
                colors: ['#667EEA'],
                plotOptions: { bar: { borderRadius: 6, columnWidth: '50%' } },
                dataLabels: { enabled: false },
                legend: { show: false },
                responsive: [{ breakpoint: 640, options: { chart: { height: 200 } } }]
            };
            const seriesChart = new ApexCharts(document.querySelector('#seriesChart'), seriesOptions);
            seriesChart.render();

            // Turmas (bar)
            const classLabels = (dashboardData.classData || []).map(i => i[0]);
            const classValues = (dashboardData.classData || []).map(i => i[1]);
            const classOptions = {
                chart: { type: 'bar', height: 280 },
                series: [{ name: 'Alunos', data: classValues }],
                xaxis: { categories: classLabels },
                colors: ['#A8EDEA'],
                plotOptions: { bar: { borderRadius: 6, columnWidth: '50%' } },
                dataLabels: { enabled: false },
                legend: { show: false },
                responsive: [{ breakpoint: 640, options: { chart: { height: 200 } } }]
            };
            const classChart = new ApexCharts(document.querySelector('#classChart'), classOptions);
            classChart.render();

            // Bairros (pie)
            const neighLabels = (dashboardData.neighborhoodData || []).map(i => i[0]);
            const neighValues = (dashboardData.neighborhoodData || []).map(i => i[1]);
            const neighOptions = {
                chart: { type: 'pie', height: 280 },
                series: neighValues,
                labels: neighLabels,
                colors: ['#667EEA','#764BA2','#4FACFE','#FA709A','#A8EDEA'],
                legend: { position: 'bottom' },
                dataLabels: { enabled: true },
                responsive: [{ breakpoint: 640, options: { chart: { height: 200 }, legend: { position: 'bottom' } } }]
            };
            const neighborhoodChart = new ApexCharts(document.querySelector('#neighborhoodChart'), neighOptions);
            neighborhoodChart.render();
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Inicializar √≠cones Lucide
                lucide.createIcons();

                // Inicializar Supabase
                await initializeSupabase();

                // Configurar event listeners para filtros
                setupFilterListeners();

                // Verificar autentica√ß√£o e carregar dados
                if (checkAuth()) {
                    await loadDashboardData();
                }
            } catch (e) {
                console.error('Erro na inicializa√ß√£o do dashboard:', e);
            }
        });

        // Configurar event listeners para filtros
        function setupFilterListeners() {
            // Pesquisa por nome do aluno
            const studentSearchInput = document.getElementById('studentSearch');
            if (studentSearchInput) {
                let searchTimeout;
                studentSearchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        applyFilters();
                    }, 500); // Debounce de 500ms
                });
            }

            // Filtros de data
            const dateFromInput = document.getElementById('dateFrom');
            const dateToInput = document.getElementById('dateTo');
            
            if (dateFromInput) {
                dateFromInput.addEventListener('change', applyFilters);
            }
            
            if (dateToInput) {
                dateToInput.addEventListener('change', applyFilters);
            }

            // Bot√£o limpar filtros
            const clearButton = document.getElementById('clearFilters');
            if (clearButton) {
                clearButton.addEventListener('click', clearFilters);
            }
        }

        // Cleanup ao sair da p√°gina
        window.addEventListener('beforeunload', () => {
            if (logsSubscription) {
                supabase.removeChannel(logsSubscription);
            }
        });
    </script>
</body>
</html>