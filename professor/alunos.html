<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alunos - Professor - Escola Log</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Visualiza√ß√£o de alunos das turmas do professor - Escola Log">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Escola Log">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="../img/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../img/favicon.png">
    <link rel="apple-touch-icon" href="../img/metatag.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="../manifest.json">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
            padding: 16px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 48px;
            max-width: 100%;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .back-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .professor-info {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .turmas-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .professor-info h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .turmas-list {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            align-items: center;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .turma-badge {
            background: #e2e8f0;
            color: #64748b;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            height: 32px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            user-select: none;
        }

        .turma-badge:hover {
            background: #cbd5e1;
            transform: translateY(-1px);
        }

        .turma-badge.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .turma-badge.active:hover {
            background: #2563eb;
        }

        .search-filters {
            background: white;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
        }

        .filters-title {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters-toggle {
            transition: transform 0.3s ease;
        }

        .filters-toggle.open {
            transform: rotate(180deg);
        }

        .filters-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .search-icon:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .filters-content {
            padding: 20px;
            display: none;
        }

        .filters-content.open {
            display: block;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: #374151;
        }

        .form-input {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .students-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .students-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .students-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            padding: 20px;
        }

        .student-card {
            background: white;
            border: 2px solid #3b82f6; /* default, overridden by palette */
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 140px;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        /* Paleta de cores para a borda dos cards */
        .students-grid .student-card:nth-child(6n+1) { border-color: #3b82f6; } /* blue */
        .students-grid .student-card:nth-child(6n+2) { border-color: #0ea5e9; } /* sky */
        .students-grid .student-card:nth-child(6n+3) { border-color: #6366f1; } /* indigo */
        .students-grid .student-card:nth-child(6n+4) { border-color: #8b5cf6; } /* violet */
        .students-grid .student-card:nth-child(6n+5) { border-color: #06b6d4; } /* cyan */
        .students-grid .student-card:nth-child(6n)   { border-color: #10b981; } /* emerald */

        .student-card-photo-container {
            margin-bottom: 12px;
        }

        .student-card-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .student-card-photo-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .student-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .student-card-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .student-card-class {
            font-size: 0.75rem;
            color: #64748b;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
            font-weight: 500;
        }

        .student-card-body {
            padding: 20px;
        }

        .student-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .student-detail {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .student-detail:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }

        .student-detail-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .student-detail-value {
            color: #1e293b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .student-card-footer {
            padding: 15px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-card-matricula {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .student-card-action {
            color: #3b82f6;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.1);
            height: 28px;
            box-sizing: border-box;
        }

        .student-card-action:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.2);
            transform: translateX(2px);
        }

        .student-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

        .student-photo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }




        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
            transform: scale(1.1);
        }

        .modal-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-photo-section {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e2e8f0;
            margin: 0 auto 15px;
            display: block;
        }

        .modal-photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 2.5rem;
            margin: 0 auto 15px;
        }

        .modal-photo-edit {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            height: 44px;
            box-sizing: border-box;
            margin: 0 auto;
            display: block;
        }

        .modal-photo-edit:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .modal-photo-edit:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }

        .modal-details {
            display: grid;
            gap: 15px;
            width: 100%;
            max-width: 100%;
        }

        .modal-detail-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-detail {
            display: flex;
            flex-direction: column;
        }

        .modal-detail-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .modal-detail-value {
            color: #1e293b;
            font-size: 0.9rem;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .modal-detail-full {
            grid-column: 1 / -1;
        }

        /* File input hidden */
        .photo-input {
            display: none;
        }


        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            height: 44px;
            box-sizing: border-box;
            min-width: 120px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: row;
                gap: 8px;
                padding: 12px 16px;
                margin-bottom: 15px;
                align-items: center;
            }

            .header-left {
                flex: 1;
                min-width: 0;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .header-right {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .logo img {
                height: 32px;
                flex-shrink: 0;
            }

            .page-title {
                font-size: 1rem;
                margin-left: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .back-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            .add-student-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .students-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 12px;
                padding: 15px;
            }

            .student-card-header {
                padding: 15px;
                gap: 12px;
            }

            .student-card-photo,
            .student-card-photo-placeholder {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .student-card-body {
                padding: 15px;
            }

            .student-card-details {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .student-detail {
                padding: 10px;
            }

            .student-card-footer {
                padding: 12px 15px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .modal {
                margin: 10px;
                max-height: 95vh;
            }

            .modal-detail-group {
                grid-template-columns: 1fr;
            }

            .turmas-list {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 6px;
            }

            .turma-badge {
                font-size: 0.8rem;
                padding: 6px 12px;
                height: 28px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 12px;
            }

            .logo img {
                height: 35px;
            }

            .page-title {
                font-size: 1.3rem;
            }

            .students-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
                padding: 10px;
            }

            .student-card-header {
                padding: 12px;
                gap: 10px;
            }

            .student-card-photo,
            .student-card-photo-placeholder {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .student-card-name {
                font-size: 1rem;
            }

            .student-card-body {
                padding: 12px;
            }

            .student-card-details {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .student-detail {
                padding: 8px;
            }

            .student-detail-label {
                font-size: 0.7rem;
            }

            .student-detail-value {
                font-size: 0.8rem;
            }

            .student-card-footer {
                padding: 10px 12px;
            }

            .modal {
                margin: 5px;
            }

            .modal-content {
                padding: 15px;
            }

            .modal-photo {
                width: 100px;
                height: 100px;
            }

            .modal-photo-placeholder {
                width: 100px;
                height: 100px;
                font-size: 2rem;
            }
        }

        /* Garantir 2 colunas em telas pequenas */
        @media (max-width: 360px) {
            .students-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                padding: 8px;
            }

            .student-card {
                padding: 12px;
                min-height: 120px;
            }

            .student-card-photo-container {
                margin-bottom: 8px;
            }

            .student-card-photo,
            .student-card-photo-placeholder {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .student-card-name {
                font-size: 0.8rem;
                margin-bottom: 4px;
            }

            .student-card-class {
                font-size: 0.65rem;
                padding: 3px 6px;
            }
        }

        /* Garantir 2 colunas em telas muito pequenas */
        @media (max-width: 320px) {
            .students-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                padding: 8px;
            }

            .student-card {
                padding: 10px;
                min-height: 110px;
            }

            .student-card-photo-container {
                margin-bottom: 6px;
            }

            .student-card-photo,
            .student-card-photo-placeholder {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .student-card-name {
                font-size: 0.75rem;
                margin-bottom: 3px;
            }

            .student-card-class {
                font-size: 0.6rem;
                padding: 2px 5px;
            }
        }
    </style>
    <style>
        /* Mobile readability boost (no header changes) */
        @media (max-width: 768px) {
            body { font-size: 16px; }
            .students-title { font-size: 1.2rem; }
            .student-card-name { font-size: 1rem; }
            .student-card-class { font-size: 0.85rem; }
            .student-detail-label { font-size: 0.8rem; }
            .student-detail-value { font-size: 1rem; }
            .student-card-action { font-size: 0.9rem; }
            .modal-title { font-size: 1.35rem; }
            .modal-detail-label { font-size: 0.9rem; }
            .modal-detail-value { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo" onclick="window.location.href='menu.html'" style="cursor: pointer;">
                    <img src="../img/logo-horizonal.png" alt="Escola Log">
                </div>
            </div>
            
            <div class="header-right">
                <a href="menu.html" class="back-btn" aria-label="Voltar">
                    <i data-lucide="chevron-left"></i>
                </a>
            </div>
        </header>

        <!-- Informa√ß√µes do Professor -->
        <div class="professor-info" id="professorInfo" style="display: none;">
            <h3>üìö Suas Turmas</h3>
            <div class="turmas-list" id="turmasList" style="margin-top:10px;">
                <!-- Turmas ser√£o carregadas aqui -->
            </div>
        </div>

        <!-- Filtros de Busca -->
        <div class="search-filters">
            <div class="filters-header" onclick="toggleFilters()">
                <div class="filters-title">
                    üîç Filtros de Busca
                </div>
                <div class="filters-actions">
                    <button class="search-icon" onclick="searchAndCloseFilters(event)" title="Pesquisar e fechar filtros">
                        üîç
                    </button>
                    <div class="filters-toggle" id="filtersToggle">‚ñº</div>
                </div>
            </div>
            <div class="filters-content" id="filtersContent">
            <div class="filters-grid">
                <div class="form-group">
                    <label class="form-label" for="searchName">Nome do Aluno</label>
                    <input type="text" id="searchName" class="form-input" placeholder="Digite o nome..." onkeyup="filterStudents()">
                </div>
                <div class="form-group">
                    <label class="form-label" for="searchMatricula">Matr√≠cula</label>
                    <input type="text" id="searchMatricula" class="form-input" placeholder="Digite a matr√≠cula..." onkeyup="filterStudents()">
                </div>
                <div class="form-group">
                    <label class="form-label" for="filterClass">Turma</label>
                    <select id="filterClass" class="form-input" onchange="filterStudents()">
                        <option value="">Todas as turmas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="filterSerie">S√©rie</label>
                    <select id="filterSerie" class="form-input" onchange="filterStudents()">
                        <option value="">Todas as s√©ries</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="filterSexo">Sexo</label>
                    <select id="filterSexo" class="form-input" onchange="filterStudents()">
                        <option value="">Todos</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                    </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards de Alunos -->
        <div class="students-container">
            <div class="students-header">
                <h2 class="students-title">Meus Alunos</h2>
                <span id="studentsCount">0 alunos</span>
            </div>
            <div class="students-grid" id="studentsGrid">
                <div class="loading">
                                <div class="spinner"></div>
                                Carregando alunos...
                </div>
            </div>
        </div>

        <!-- Modal de Detalhes do Aluno -->
        <div class="modal-overlay" id="studentModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Detalhes do Aluno</h3>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                <div class="modal-content">
                    <div class="modal-photo-section">
                        <img id="modalPhoto" class="modal-photo" style="display: none;" alt="Foto do aluno">
                        <div id="modalPhotoPlaceholder" class="modal-photo-placeholder"></div>
                        <button class="modal-photo-edit" onclick="editPhoto()">üì∑ Alterar Foto</button>
                        <input type="file" id="photoInput" class="photo-input" accept="image/*" capture="environment" onchange="handlePhotoChange(event)">
                    </div>
                    <div class="modal-details" id="modalDetails">
                        <!-- Detalhes ser√£o preenchidos via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Configura√ß√£o global
        let supabase = null;
        let currentUser = null;
        let professorPermissions = [];
        let students = [];
        let turmas = [];
        let currentStudent = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inicializando Alunos do Professor...');
            
            try {
                // Verificar autentica√ß√£o
                if (!await checkAuthentication()) {
                    return;
                }

                // Inicializar Supabase
                await initializeSupabase();
                
                // Buscar permiss√µes do professor
                await getProfessorPermissions();
                
                // Carregar alunos das turmas permitidas
                await loadStudents();
                
                console.log('‚úÖ Alunos do professor inicializados com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar alunos:', error);
                alert('Erro ao inicializar: ' + error.message);
            }
        });

        // Verificar autentica√ß√£o
        async function checkAuthentication() {
            try {
                const whatsappUser = localStorage.getItem('whatsapp_user');
                
                if (!whatsappUser) {
                    console.log('‚ùå Usu√°rio n√£o autenticado');
                    window.location.href = '../login.html';
                    return false;
                }
                
                currentUser = JSON.parse(whatsappUser);
                console.log('üîç Dados do usu√°rio carregados:', currentUser);
                console.log('üîç Chaves do objeto user:', Object.keys(currentUser));
                console.log('üîç Valores do objeto user:', Object.values(currentUser));
                
                if (currentUser.tipo_usuario !== 'professor') {
                    console.log('‚ùå Usu√°rio n√£o √© professor:', currentUser.tipo_usuario);
                    alert('Acesso negado. Esta √°rea √© exclusiva para professores.');
                    window.location.href = '../login.html';
                    return false;
                }
                
                console.log('‚úÖ Professor autorizado:', currentUser.nome);
                console.log('üì± WhatsApp do usu√°rio:', currentUser.whatsapp);
                console.log('üì± Telefone do usu√°rio:', currentUser.telefone);
                console.log('üì± Phone do usu√°rio:', currentUser.phone);
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o de autentica√ß√£o:', error);
                window.location.href = '../login.html';
                return false;
            }
        }

        // Inicializar Supabase
        async function initializeSupabase() {
            try {
                console.log('üîß Inicializando Supabase...');
                
                let url, key;
                
                try {
                    // Buscar chaves via Lambda
                    const response = await fetch('https://yfh5dmsuucx76bronca7f7k3le0sjykd.lambda-url.us-east-2.on.aws/');
                    const result = await response.json();
                    
                    if (result.data && result.data.url && result.data.key) {
                        url = result.data.url;
                        key = result.data.key;
                    // N√£o logar chaves obtidas da Lambda
                    } else {
                        throw new Error('Lambda n√£o retornou dados v√°lidos');
                    }
                } catch (lambdaError) {
                    // Erro na Lambda, fallback sem detalhes
                    
                    // Fallback para chaves hardcoded
                    url = 'https://sntyndufbxfzasnqvayc.supabase.co';
                    key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNudHluZHVmYnhmemFzbnF2YXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzQ2ODcsImV4cCI6MjA3MTc1MDY4N30.Pv9CaNkpo2HMMAtPbyLz2AdR8ZyK1jtHbP78pR5CPSM';
                }
                
                // Inicializar cliente Supabase
                supabase = window.supabase.createClient(url, key);
                console.log('‚úÖ Supabase inicializado');
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                throw error;
            }
        }

        // Buscar permiss√µes do professor
        async function getProfessorPermissions() {
            try {
                console.log('üîç Buscando permiss√µes do professor...');
                console.log('üë§ Current user:', currentUser);
                
                // Verificar se o ID do usu√°rio est√° dispon√≠vel
                if (!currentUser.id) {
                    console.error('‚ùå ID do usu√°rio n√£o encontrado:', currentUser);
                    throw new Error('ID do usu√°rio n√£o encontrado. Fa√ßa login novamente.');
                }
                
                console.log('üÜî ID do usu√°rio:', currentUser.id);

                // Buscar permiss√µes do usu√°rio
                const { data: permissoesData, error: permissoesError } = await supabase
                    .from('permissoes')
                    .select(`
                        id,
                        tipo,
                        referencia_id
                    `)
                    .eq('usuario_id', currentUser.id)
                    .eq('tipo', 'turma')
                    .eq('ativo', true);

                if (permissoesError) {
                    throw new Error('Erro ao buscar permiss√µes: ' + permissoesError.message);
                }

                if (!permissoesData || permissoesData.length === 0) {
                    throw new Error('Nenhuma permiss√£o encontrada para este professor');
                }

                // Buscar turmas das permiss√µes
                const turmaIds = permissoesData.map(p => p.referencia_id);
                
                const { data: turmasData, error: turmasError } = await supabase
                    .from('turmas')
                    .select(`
                            id,
                            nome,
                            escola_id,
                            serie_id,
                            escolas (
                                id,
                                nome
                            ),
                            series (
                                id,
                                nome
                            )
                    `)
                    .in('id', turmaIds)
                    .eq('soft_delete', false);

                if (turmasError) {
                    throw new Error('Erro ao buscar turmas: ' + turmasError.message);
                }

                professorPermissions = permissoesData;
                turmas = turmasData || [];

                console.log(`‚úÖ ${professorPermissions.length} permiss√µes encontradas`);
                console.log(`‚úÖ ${turmas.length} turmas encontradas`);
                
                // Mostrar informa√ß√µes do professor
                showProfessorInfo();
                
                // Popular filtro de turmas
                populateClassFilter();
                
                // Popular filtro de s√©ries
                populateSeriesFilter();
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar permiss√µes:', error);
                throw error;
            }
        }

        // Array para armazenar turmas selecionadas
        let selectedTurmas = [];

        // Mostrar informa√ß√µes do professor
        function showProfessorInfo() {
            const professorInfo = document.getElementById('professorInfo');
            const turmasList = document.getElementById('turmasList');
            
            turmasList.innerHTML = turmas.map(turma => 
                `<span class="turma-badge" data-turma-id="${turma.id}" onclick="toggleTurmaFilter('${turma.id}')">${turma.nome}${turma.series?.nome ? ` - ${turma.series.nome}` : ''}</span>`
            ).join('');
            
            professorInfo.style.display = 'block';
        }

        // Fun√ß√£o para alternar filtro de turma
         function toggleTurmaFilter(turmaId) {
             const turmaElement = document.querySelector(`[data-turma-id="${turmaId}"]`);
             
             if (selectedTurmas.includes(turmaId)) {
                 // Remover turma da sele√ß√£o
                 selectedTurmas = selectedTurmas.filter(id => id !== turmaId);
                 turmaElement.classList.remove('active');
             } else {
                 // Adicionar turma √† sele√ß√£o
                 selectedTurmas.push(turmaId);
                 turmaElement.classList.add('active');
             }
             
             // Atualizar lista de alunos baseada no filtro
             updateStudentList();
         }

         // Fun√ß√£o para atualizar lista de alunos baseada no filtro de turmas
         function updateStudentList() {
             let filteredStudents = students;
             
             // Se h√° turmas selecionadas, filtrar por elas
             if (selectedTurmas.length > 0) {
                 filteredStudents = students.filter(student => 
                     selectedTurmas.includes(student.turma_id)
                 );
             }
             
             // Aplicar outros filtros existentes se houver
             const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
             const selectedClass = document.getElementById('filterClass')?.value || '';
             const selectedSerie = document.getElementById('filterSerie')?.value || '';
             
             if (searchTerm) {
                 filteredStudents = filteredStudents.filter(student =>
                     student.nome.toLowerCase().includes(searchTerm) ||
                     student.matricula.toLowerCase().includes(searchTerm)
                 );
             }
             
             if (selectedClass && selectedClass !== '') {
                 filteredStudents = filteredStudents.filter(student => student.turma_id === selectedClass);
             }
             
             if (selectedSerie && selectedSerie !== '') {
                 filteredStudents = filteredStudents.filter(student => student.serie_id === selectedSerie);
             }
             
             renderStudents(filteredStudents);
             updateStudentsCount(filteredStudents.length);
         }

        // Popular filtro de turmas
        function populateClassFilter() {
            const select = document.getElementById('filterClass');
            
            turmas.forEach(turma => {
                const option = document.createElement('option');
                option.value = turma.id;
                option.textContent = turma.nome;
                select.appendChild(option);
            });
        }

        // Popular filtro de s√©ries
        function populateSeriesFilter() {
            const select = document.getElementById('filterSerie');
            
            // Obter s√©ries √∫nicas das turmas
            const seriesUnicas = new Map();
            turmas.forEach(turma => {
                if (turma.series && turma.series.id) {
                    seriesUnicas.set(turma.series.id, turma.series.nome);
                }
            });
            
            // Adicionar op√ß√µes ao select
            seriesUnicas.forEach((nome, id) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = nome;
                select.appendChild(option);
            });
        }

        // Carregar alunos das turmas permitidas
        async function loadStudents() {
            try {
                console.log('üë• Carregando alunos das turmas permitidas...');
                
                const turmaIds = turmas.map(t => t.id);
                
                if (turmaIds.length === 0) {
                    showEmptyState('Nenhuma turma encontrada para este professor');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('alunos')
                    .select(`
                        id,
                        nome,
                        matricula,
                        sexo,
                        turma_id,
                        serie_id,
                        bairro,
                        cidade,
                        whatsapp,
                        nome_responsavel_1,
                        foto_url,
                        id_control_id,
                        turmas (
                            id,
                            nome
                        ),
                        series (
                            id,
                            nome
                        )
                    `)
                    .in('turma_id', turmaIds)
                    .eq('soft_delete', false)
                    .order('nome');

                if (error) {
                    throw new Error('Erro ao carregar alunos: ' + error.message);
                }

                students = data || [];
                console.log(`‚úÖ ${students.length} alunos carregados`);
                
                renderStudents(students);
                updateStudentsCount(students.length);

            } catch (error) {
                console.error('‚ùå Erro ao carregar alunos:', error);
                showEmptyState('Erro ao carregar alunos: ' + error.message);
            }
        }

        // Renderizar alunos em cards
        function renderStudents(studentsData) {
            const grid = document.getElementById('studentsGrid');
            
            if (!studentsData || studentsData.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                            <div class="empty-state-icon">üë•</div>
                            <p>Nenhum aluno encontrado</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = studentsData.map(student => `
                <div class="student-card" onclick="openStudentModal('${student.id}')">
                    <div class="student-card-photo-container">
                        ${student.foto_url ? 
                            `<img src="${student.foto_url}" alt="${student.nome}" class="student-card-photo">` :
                            `<div class="student-card-photo-placeholder">${student.nome.charAt(0).toUpperCase()}</div>`
                        }
                    </div>
                    <div class="student-card-content">
                        <div class="student-card-name">${student.nome}</div>
                        <div class="student-card-class">${student.turmas?.nome ? `${student.turmas.nome}${student.series?.nome ? ` - ${student.series.nome}` : ''}` : 'Sem turma'}</div>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar estado vazio
        function showEmptyState(message) {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>${message}</p>
                </div>
            `;
        }

        // Atualizar contador
        function updateStudentsCount(count) {
            document.getElementById('studentsCount').textContent = `${count} aluno${count !== 1 ? 's' : ''}`;
        }

        // Filtrar alunos
        function filterStudents() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchMatricula = document.getElementById('searchMatricula').value.toLowerCase();
            const filterClass = document.getElementById('filterClass').value;
            const filterSerie = document.getElementById('filterSerie').value;
            const filterSexo = document.getElementById('filterSexo').value;

            const filtered = students.filter(student => {
                const matchName = !searchName || student.nome.toLowerCase().includes(searchName);
                const matchMatricula = !searchMatricula || (student.matricula && student.matricula.toLowerCase().includes(searchMatricula));
                const matchClass = !filterClass || student.turma_id === filterClass;
                const matchSerie = !filterSerie || student.serie_id === filterSerie;
                const matchSexo = !filterSexo || student.sexo === filterSexo;

                return matchName && matchMatricula && matchClass && matchSerie && matchSexo;
            });

            renderStudents(filtered);
            updateStudentsCount(filtered.length);
        }

        // Fun√ß√µes do Modal
        function openStudentModal(studentId) {
            currentStudent = students.find(s => s.id === studentId);
            if (!currentStudent) return;

            // Atualizar t√≠tulo
            document.getElementById('modalTitle').textContent = currentStudent.nome;

            // Atualizar foto
            const modalPhoto = document.getElementById('modalPhoto');
            const modalPhotoPlaceholder = document.getElementById('modalPhotoPlaceholder');
            
            if (currentStudent.foto_url) {
                modalPhoto.src = currentStudent.foto_url;
                modalPhoto.style.display = 'block';
                modalPhotoPlaceholder.style.display = 'none';
            } else {
                modalPhoto.style.display = 'none';
                modalPhotoPlaceholder.style.display = 'flex';
                modalPhotoPlaceholder.textContent = currentStudent.nome.charAt(0).toUpperCase();
            }

            // Atualizar detalhes
            const modalDetails = document.getElementById('modalDetails');
            modalDetails.innerHTML = `
                <div class="modal-detail-group">
                    <div class="modal-detail">
                        <div class="modal-detail-label">Nome Completo</div>
                        <div class="modal-detail-value">${currentStudent.nome}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Matr√≠cula</div>
                        <div class="modal-detail-value">${currentStudent.matricula || '-'}</div>
                    </div>
                </div>
                <div class="modal-detail-group">
                    <div class="modal-detail">
                        <div class="modal-detail-label">Sexo</div>
                        <div class="modal-detail-value">${currentStudent.sexo === 'M' ? 'Masculino' : currentStudent.sexo === 'F' ? 'Feminino' : '-'}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Data de Nascimento</div>
                        <div class="modal-detail-value">${currentStudent.data_nascimento || '-'}</div>
                    </div>
                </div>
                <div class="modal-detail-group">
                    <div class="modal-detail">
                        <div class="modal-detail-label">Turma</div>
                        <div class="modal-detail-value">${currentStudent.turmas?.nome || '-'}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">S√©rie</div>
                        <div class="modal-detail-value">${currentStudent.series?.nome || '-'}</div>
                    </div>
                </div>
                <div class="modal-detail-group">
                    <div class="modal-detail">
                        <div class="modal-detail-label">Bairro</div>
                        <div class="modal-detail-value">${currentStudent.bairro || '-'}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Cidade</div>
                        <div class="modal-detail-value">${currentStudent.cidade || '-'}</div>
                    </div>
                </div>
                <div class="modal-detail-group">
                    <div class="modal-detail">
                        <div class="modal-detail-label">WhatsApp</div>
                        <div class="modal-detail-value">${currentStudent.whatsapp || '-'}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Estado</div>
                        <div class="modal-detail-value">${currentStudent.estado || '-'}</div>
                    </div>
                </div>
                <div class="modal-detail modal-detail-full">
                    <div class="modal-detail-label">Respons√°vel Principal</div>
                    <div class="modal-detail-value">${currentStudent.nome_responsavel_1 || '-'}</div>
                </div>
                <div class="modal-detail-group">
                    <div class="modal-detail">
                        <div class="modal-detail-label">Telefone Respons√°vel</div>
                        <div class="modal-detail-value">${currentStudent.telefone_responsavel_1 || '-'}</div>
                    </div>
                    <div class="modal-detail">
                        <div class="modal-detail-label">Segundo Respons√°vel</div>
                        <div class="modal-detail-value">${currentStudent.responsavel_2 || '-'}</div>
                    </div>
                </div>
            `;

            // Mostrar modal
            document.getElementById('studentModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('studentModal').classList.remove('open');
            currentStudent = null;
        }

        // Fun√ß√µes de Filtros
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const toggle = document.getElementById('filtersToggle');
            
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function searchAndCloseFilters(event) {
            // Impedir que o clique no √≠cone acione o toggleFilters do header
            event.stopPropagation();
            
            // Executar a pesquisa
            filterStudents();
            
            // Fechar os filtros
            const content = document.getElementById('filtersContent');
            const toggle = document.getElementById('filtersToggle');
            
            content.classList.remove('open');
            toggle.classList.remove('open');

            // Scroll suave para a lista de alunos
            const target = document.querySelector('.students-container') || document.getElementById('studentsGrid');
            if (target && typeof target.scrollIntoView === 'function') {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Fun√ß√µes de Foto
        function editPhoto() {
            document.getElementById('photoInput').click();
        }

        // Verificar se o bucket de fotos existe
        async function checkPhotoBucket() {
            try {
                const { data, error } = await supabase.storage
                    .from('fotos_alunos')
                    .list('', { limit: 1 });
                
                if (error) {
                    console.warn('Bucket fotos_alunos n√£o encontrado:', error);
                    return false;
                }
                return true;
            } catch (error) {
                console.warn('Erro ao verificar bucket:', error);
                return false;
            }
        }

        // Fun√ß√£o para comprimir imagem
        async function compressImage(file, maxSizeKB = 200, quality = 0.7) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calcular dimens√µes mantendo propor√ß√£o
                    let { width, height } = img;
                    const maxDimension = 800; // M√°ximo de 800px para dispositivos de controle
                    
                    if (width > height && width > maxDimension) {
                        height = (height * maxDimension) / width;
                        width = maxDimension;
                    } else if (height > maxDimension) {
                        width = (width * maxDimension) / height;
                        height = maxDimension;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Desenhar imagem redimensionada
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Fun√ß√£o recursiva para ajustar qualidade at√© atingir o tamanho desejado
                    function tryCompress(currentQuality) {
                        canvas.toBlob((blob) => {
                            const sizeKB = blob.size / 1024;
                            
                            if (sizeKB <= maxSizeKB || currentQuality <= 0.1) {
                                // Criar novo arquivo com o blob comprimido
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                console.log(`üì¶ Imagem comprimida: ${Math.round(file.size / 1024)}KB ‚Üí ${Math.round(compressedFile.size / 1024)}KB`);
                                resolve(compressedFile);
                            } else {
                                // Reduzir qualidade e tentar novamente
                                tryCompress(currentQuality - 0.1);
                            }
                        }, 'image/jpeg', currentQuality);
                    }
                    
                    tryCompress(quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Fun√ß√£o para detectar dispositivos m√≥veis
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768 && window.innerHeight <= 1024);
        }

        // Fun√ß√£o para obter sess√£o do dispositivo
        async function getDeviceSession(ipAddress, login, password) {
            try {
                const ipAddressWithPort = ipAddress.includes(':') ? ipAddress : `${ipAddress}:80`;
                
                console.log(`üîê Obtendo sess√£o para ${ipAddressWithPort} com login: ${login}`);
                
                // Detectar ambiente e dispositivo
                const isHttps = window.location.protocol === 'https:';
                const isMobile = isMobileDevice();
                
                console.log(`üì± Dispositivo m√≥vel: ${isMobile ? 'SIM' : 'N√ÉO'}`);
                
                // Em dispositivos m√≥veis com HTTPS, pular autentica√ß√£o de dispositivos
                // pois n√£o conseguem acessar o proxy local
                if (isMobile && isHttps) {
                    console.log('üì± Dispositivo m√≥vel em HTTPS - pulando autentica√ß√£o de dispositivos locais');
                    throw new Error('MOBILE_SKIP_DEVICES');
                }
                let response;
                
                if (isHttps) {
                    // Em ambiente HTTPS, usar proxy para evitar Mixed Content
                    console.log('üîí Ambiente HTTPS detectado - usando proxy para evitar Mixed Content');
                    
                    try {
                        // Tentar proxy local primeiro
                        response = await fetch('http://localhost:3001/proxy/fcgi', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                url: `http://${ipAddressWithPort}/login.fcgi`,
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    login: login || 'admin',
                                    password: password || 'admin'
                                })
                            })
                        });
                    } catch (proxyError) {
                        console.warn('‚ö†Ô∏è Proxy local n√£o dispon√≠vel, tentando chamada direta (pode falhar em HTTPS)');
                        // Fallback para chamada direta (pode falhar em HTTPS)
                        response = await fetch(`http://${ipAddressWithPort}/login.fcgi`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                login: login || 'admin',
                                password: password || 'admin'
                            })
                        });
                    }
                } else {
                    // Em ambiente HTTP, fazer chamada direta
                    console.log('üîì Ambiente HTTP - fazendo chamada direta');
                    response = await fetch(`http://${ipAddressWithPort}/login.fcgi`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            login: login || 'admin',
                            password: password || 'admin'
                        })
                    });
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.session) {
                    throw new Error('Sess√£o n√£o retornada pelo dispositivo');
                }

                console.log(`‚úÖ Sess√£o obtida com sucesso: ${data.session.substring(0, 10)}...`);
                return data.session;
                
            } catch (error) {
                console.error('‚ùå Erro ao obter sess√£o:', error);
                throw new Error(`N√£o foi poss√≠vel autenticar no dispositivo: ${error.message}`);
            }
        }

        async function updatePhotoOnDevice(student, photoFile) {
            console.log('üîß Iniciando atualiza√ß√£o de foto nos dispositivos...');
            
            // Verificar se √© dispositivo m√≥vel em HTTPS
            const isMobile = isMobileDevice();
            const isHttps = window.location.protocol === 'https:';
            
            if (isMobile && isHttps) {
                console.log('üì± Dispositivo m√≥vel detectado em HTTPS - apenas atualizando Supabase Storage');
                console.log('‚ÑπÔ∏è Dispositivos de controle de acesso n√£o ser√£o atualizados devido a limita√ß√µes de seguran√ßa');
                return true; // Foto j√° foi salva no Supabase Storage pela Lambda
            }
            
            try {
                // 1. Buscar TODOS os dispositivos associados ao aluno
                console.log('üîç Buscando TODOS os dispositivos associados ao aluno...');
                
                const { data: deviceData, error: deviceError } = await supabase
                    .from('aluno_dispositivo')
                    .select(`
                        id_do_aluno_no_dispositivo,
                        dispositivos!inner(
                            id,
                            nome,
                            ip,
                            login,
                            senha,
                            status
                        )
                    `)
                    .eq('aluno', student.id)
                    .eq('dispositivos.status', 'ATIVO');

                if (deviceError) {
                    console.error('‚ùå Erro ao buscar dispositivo:', deviceError);
                    throw new Error('Erro ao buscar dispositivo associado: ' + deviceError.message);
                }

                console.log('üì± Dados dos dispositivos encontrados:', deviceData);

                if (!deviceData || deviceData.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum dispositivo ativo encontrado para este aluno');
                    return true; // N√£o √© erro cr√≠tico, apenas n√£o h√° dispositivos
                }

                console.log(`üéØ ${deviceData.length} dispositivo(s) encontrado(s) para atualiza√ß√£o`);

                // 2. Converter foto para ArrayBuffer uma √∫nica vez
                console.log('üîÑ Convertendo foto para envio aos dispositivos...');
                const arrayBuffer = await photoFile.arrayBuffer();
                
                // 3. Atualizar foto em TODOS os dispositivos
                const updatePromises = deviceData.map(async (device, index) => {
                    const deviceIp = device.dispositivos.ip.replace(/\/$/, ''); // Remove trailing slash
                    const studentDeviceId = device.id_do_aluno_no_dispositivo;
                    const deviceName = device.dispositivos.nome;
                    const deviceId = device.dispositivos.id;

                    console.log(`üì§ [${index + 1}/${deviceData.length}] Enviando foto para dispositivo "${deviceName}" (ID: ${deviceId})...`);
                    
                    try {
                        // 1. Obter sess√£o do dispositivo
                        console.log(`üîê [${deviceName}] Obtendo sess√£o de autentica√ß√£o...`);
                        const session = await getDeviceSession(
                            deviceIp, 
                            device.dispositivos.login, 
                            device.dispositivos.senha
                        );
                        
                        // 2. Fazer requisi√ß√£o com sess√£o
                        const timestamp = Math.floor(Date.now() / 1000);
                        const deviceUrl = `http://${deviceIp}/user_set_image.fcgi?user_id=${studentDeviceId}&session=${session}&timestamp=${timestamp}`;
                        
                        // Configura√ß√£o da requisi√ß√£o com timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos timeout (mais tempo para sess√£o)
                        
                        console.log(`üîÑ [${deviceName}] Enviando foto com sess√£o autenticada...`);
                        
                        // Detectar se estamos em ambiente HTTPS
                        const isHttps = window.location.protocol === 'https:';
                        let deviceResponse;
                        
                        if (isHttps) {
                            // Em ambiente HTTPS, usar proxy para evitar Mixed Content
                            console.log(`üîí [${deviceName}] Ambiente HTTPS - usando proxy para envio de foto`);
                            
                            try {
                                // Tentar proxy local primeiro
                                deviceResponse = await fetch('http://localhost:3001/proxy/fcgi', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        url: deviceUrl,
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/octet-stream'
                                        },
                                        body: Array.from(new Uint8Array(arrayBuffer)) // Converter ArrayBuffer para array
                                    }),
                                    signal: controller.signal
                                });
                            } catch (proxyError) {
                                console.warn(`‚ö†Ô∏è [${deviceName}] Proxy local n√£o dispon√≠vel, tentando chamada direta (pode falhar em HTTPS)`);
                                // Fallback para chamada direta (pode falhar em HTTPS)
                                deviceResponse = await fetch(deviceUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/octet-stream'
                                    },
                                    body: arrayBuffer,
                                    signal: controller.signal
                                });
                            }
                        } else {
                            // Em ambiente HTTP, fazer chamada direta
                            console.log(`üîì [${deviceName}] Ambiente HTTP - fazendo chamada direta`);
                            deviceResponse = await fetch(deviceUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/octet-stream'
                                },
                                body: arrayBuffer,
                                signal: controller.signal
                            });
                        }

                        clearTimeout(timeoutId);

                        console.log(`üì° [${deviceName}] Resposta:`, {
                            status: deviceResponse.status,
                            statusText: deviceResponse.statusText,
                            ok: deviceResponse.ok
                        });

                        if (!deviceResponse.ok) {
                            const errorText = await deviceResponse.text();
                            console.error(`‚ùå [${deviceName}] Erro na resposta:`, errorText);
                            return {
                                success: false,
                                deviceName,
                                deviceId,
                                error: `${deviceResponse.status} - ${errorText}`
                            };
                        }

                        const deviceResult = await deviceResponse.text();
                        console.log(`‚úÖ [${deviceName}] Resultado:`, deviceResult);

                        // Verificar se a resposta indica sucesso
                        if (deviceResult.includes('error') || deviceResult.includes('Error')) {
                            console.error(`‚ùå [${deviceName}] Dispositivo retornou erro:`, deviceResult);
                            return {
                                success: false,
                                deviceName,
                                deviceId,
                                error: deviceResult
                            };
                        }

                        console.log(`üéâ [${deviceName}] Foto atualizada com sucesso!`);
                        return {
                            success: true,
                            deviceName,
                            deviceId,
                            message: 'Foto atualizada com sucesso'
                        };

                    } catch (error) {
                        console.error(`‚ùå [${deviceName}] Erro ao conectar:`, error);
                        
                        let errorMessage = 'Erro desconhecido';
                        
                        if (error.name === 'AbortError') {
                            errorMessage = 'Timeout - Dispositivo n√£o respondeu em 10 segundos';
                        } else if (error.message.includes('Failed to fetch')) {
                            errorMessage = 'Dispositivo offline ou inacess√≠vel';
                        } else if (error.message.includes('CORS')) {
                            errorMessage = 'Erro de CORS - Configura√ß√£o do dispositivo';
                        } else if (error.message.includes('NetworkError')) {
                            errorMessage = 'Erro de rede - Verifique a conectividade';
                        } else {
                            errorMessage = error.message;
                        }
                        
                        return {
                            success: false,
                            deviceName,
                            deviceId,
                            error: errorMessage
                        };
                    }
                });

                // 4. Aguardar todas as atualiza√ß√µes
                console.log('‚è≥ Aguardando atualiza√ß√£o em todos os dispositivos...');
                const results = await Promise.all(updatePromises);

                // 5. Analisar resultados
                const successful = results.filter(r => r.success);
                const failed = results.filter(r => !r.success);

                console.log(`üìä Resumo da atualiza√ß√£o:`);
                console.log(`‚úÖ Sucessos: ${successful.length}/${results.length}`);
                console.log(`‚ùå Falhas: ${failed.length}/${results.length}`);

                if (successful.length > 0) {
                    console.log('‚úÖ Dispositivos atualizados com sucesso:', successful.map(r => r.deviceName));
                }

                if (failed.length > 0) {
                    console.warn('‚ö†Ô∏è Dispositivos com falha:', failed.map(r => `${r.deviceName}: ${r.error}`));
                }

                // Considera sucesso se pelo menos um dispositivo foi atualizado
                const overallSuccess = successful.length > 0;
                
                if (overallSuccess) {
                    console.log('üéâ Atualiza√ß√£o conclu√≠da! Pelo menos um dispositivo foi atualizado com sucesso.');
                } else {
                    console.error('‚ùå Falha total: Nenhum dispositivo foi atualizado com sucesso.');
                }

                return overallSuccess;

            } catch (error) {
                console.error('‚ùå Erro geral ao atualizar foto nos dispositivos:', error);
                // N√£o interrompe o fluxo principal, apenas loga o erro
                return false;
            }
        }

        // Fun√ß√£o para fazer upload da foto para o Supabase Storage
        async function uploadPhotoToSupabase(file, fileName) {
            try {
                console.log('üì§ Fazendo upload para Supabase Storage...');
                
                // Upload para o bucket 'fotos'
                const { data, error } = await supabase.storage
                    .from('fotos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true // Sobrescrever se j√° existir
                    });

                if (error) {
                    console.error('‚ùå Erro no upload:', error);
                    throw error;
                }

                console.log('‚úÖ Upload conclu√≠do:', data);

                // Obter URL p√∫blica da foto
                const { data: urlData } = supabase.storage
                    .from('fotos')
                    .getPublicUrl(fileName);

                console.log('üîó URL p√∫blica gerada:', urlData.publicUrl);
                return urlData.publicUrl;

            } catch (error) {
                console.error('‚ùå Erro no upload para Supabase:', error);
                throw error;
            }
        }

        // Fun√ß√£o para atualizar foto do aluno no banco de dados
        async function updateStudentPhotoInDatabase(studentId, photoUrl) {
            try {
                console.log('üíæ Atualizando foto no banco de dados...');
                
                const { data, error } = await supabase
                    .from('alunos')
                    .update({ foto_url: photoUrl })
                    .eq('id', studentId)
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao atualizar banco:', error);
                    throw error;
                }

                console.log('‚úÖ Foto atualizada no banco:', data);
                return data[0];

            } catch (error) {
                console.error('‚ùå Erro ao atualizar banco de dados:', error);
                throw error;
            }
        }

        // Fun√ß√£o para sincronizar com dispositivos via Lambda (NOVA VERS√ÉO - M√∫ltiplas chamadas)
        async function syncPhotoWithDevices(studentData) {
            try {
                console.log('üîß Iniciando sincroniza√ß√£o com dispositivos...');
                
                // 1. Primeiro, listar todos os dispositivos dispon√≠veis
                console.log('üìã Listando dispositivos dispon√≠veis...');
                const listDevicesPayload = {
                    operation: 'list_devices',
                    student_id: currentStudent.id
                };

                const listResponse = await fetch('https://so2m6ipkdtqex3td5z75x27gfa0qjont.lambda-url.us-east-2.on.aws/', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(listDevicesPayload)
                });

                const listResult = await listResponse.json();
                
                if (!listResponse.ok || !listResult.devices) {
                    console.warn('‚ö†Ô∏è Falha ao listar dispositivos:', listResult.error);
                    return false;
                }

                const devices = listResult.devices;
                console.log(`üì± Encontrados ${devices.length} dispositivos:`, devices);

                if (devices.length === 0) {
                    console.log('‚ÑπÔ∏è Nenhum dispositivo encontrado para sincroniza√ß√£o');
                    return true; // N√£o √© erro, apenas n√£o h√° dispositivos
                }

                // 2. Sincronizar cada dispositivo individualmente com intervalo de 1s
                let successCount = 0;
                let failureCount = 0;

                for (let i = 0; i < devices.length; i++) {
                    const device = devices[i];
                    console.log(`üì± [${i + 1}/${devices.length}] Sincronizando dispositivo: ${device.nome} (ID: ${device.id})`);

                    try {
                        // Preparar dados para sincroniza√ß√£o do dispositivo espec√≠fico
                        const deviceSyncPayload = {
                            operation: 'update_single_device',
                            student_id: currentStudent.id,
                            device_id: device.id,
                            photo_url: studentData.foto_url,
                            retries: 2,
                            device_update_timeout: 20,
                            device_login_timeout: 10
                        };

                        const deviceResponse = await fetch('https://so2m6ipkdtqex3td5z75x27gfa0qjont.lambda-url.us-east-2.on.aws/', {
                            method: 'POST',
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(deviceSyncPayload)
                        });

                        const deviceResult = await deviceResponse.json();
                        
                        if (deviceResponse.ok && deviceResult.message) {
                            console.log(`‚úÖ [${i + 1}/${devices.length}] Dispositivo ${device.nome} sincronizado com sucesso`);
                            successCount++;
                        } else {
                            console.warn(`‚ùå [${i + 1}/${devices.length}] Falha ao sincronizar dispositivo ${device.nome}:`, deviceResult.error);
                            failureCount++;
                        }

                    } catch (error) {
                        console.error(`‚ùå [${i + 1}/${devices.length}] Erro ao sincronizar dispositivo ${device.nome}:`, error);
                        failureCount++;
                    }

                    // Aguardar 1 segundo antes do pr√≥ximo dispositivo (exceto no √∫ltimo)
                    if (i < devices.length - 1) {
                        console.log('‚è±Ô∏è Aguardando 1 segundo antes do pr√≥ximo dispositivo...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                // 3. Log do resultado final
                console.log(`üìä RESULTADO DA SINCRONIZA√á√ÉO:`);
                console.log(`   ‚îú‚îÄ Total de dispositivos: ${devices.length}`);
                console.log(`   ‚îú‚îÄ Sucessos: ${successCount}`);
                console.log(`   ‚îú‚îÄ Falhas: ${failureCount}`);
                console.log(`   ‚îî‚îÄ Taxa de sucesso: ${((successCount / devices.length) * 100).toFixed(1)}%`);

                // Considerar sucesso se pelo menos um dispositivo foi sincronizado
                const success = successCount > 0;
                
                if (success) {
                    console.log('üéâ Sincroniza√ß√£o conclu√≠da com sucesso!');
                } else {
                    console.warn('‚ö†Ô∏è Nenhum dispositivo foi sincronizado com sucesso');
                }

                return success;

            } catch (error) {
                console.error('‚ùå Erro cr√≠tico na sincroniza√ß√£o com dispositivos:', error);
                return false;
            }
        }

        // Fun√ß√£o para lidar com mudan√ßa de foto (NOVA VERS√ÉO - Supabase direto)
        async function handlePhotoChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üì∏ Iniciando processo de edi√ß√£o de foto...');
            console.log('üìÅ Arquivo selecionado:', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            console.log('üë§ Aluno atual:', {
                id: currentStudent.id,
                nome: currentStudent.nome,
                id_control_id: currentStudent.id_control_id
            });

            // Validar tipo de arquivo
            if (!file.type.startsWith('image/')) {
                console.error('‚ùå Tipo de arquivo inv√°lido:', file.type);
                alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }

            // Validar tamanho (m√°ximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                console.error('‚ùå Arquivo muito grande:', file.size);
                alert('A imagem deve ter no m√°ximo 5MB.');
                return;
            }

            // Verificar se h√° um aluno selecionado
            if (!currentStudent || !currentStudent.id) {
                console.error('‚ùå Aluno n√£o selecionado:', currentStudent);
                alert('‚ùå Nenhum aluno selecionado.');
                return;
            }

            try {
                // Mostrar loading
                const editButton = document.querySelector('.modal-photo-edit');
                const originalText = editButton.textContent;
                editButton.textContent = 'üì¶ Comprimindo...';
                editButton.disabled = true;

                // Comprimir imagem antes de processar
                console.log('üì¶ Comprimindo imagem...');
                const compressedFile = await compressImage(file, 200, 0.7);
                console.log('‚úÖ Compress√£o conclu√≠da');

                // Atualizar status
                editButton.textContent = 'üì§ Enviando...';

                // Gerar nome √∫nico para o arquivo
                const timestamp = Date.now();
                const fileName = `aluno_${currentStudent.id}_${timestamp}.jpg`;
                console.log('üìÅ Nome do arquivo:', fileName);

                // 1. Upload da foto para Supabase Storage
                const photoUrl = await uploadPhotoToSupabase(compressedFile, fileName);
                
                // Atualizar status
                editButton.textContent = 'üíæ Salvando...';

                // 2. Atualizar banco de dados
                const updatedStudent = await updateStudentPhotoInDatabase(currentStudent.id, photoUrl);
                
                // Atualizar status
                editButton.textContent = 'üîß Sincronizando...';

                // 3. Sincronizar com dispositivos (opcional - n√£o bloqueia o processo)
                let devicesSynced = false;
                if (currentStudent.id_control_id) {
                    devicesSynced = await syncPhotoWithDevices({
                        id_control_id: currentStudent.id_control_id,
                        foto_url: photoUrl
                    });
                }

                // Atualizar interface com a nova foto
                console.log('üñºÔ∏è Nova URL da foto:', photoUrl);
                currentStudent.foto_url = photoUrl;
                
                // Atualizar foto no modal
                const modalPhoto = document.getElementById('modalPhoto');
                const modalPhotoPlaceholder = document.getElementById('modalPhotoPlaceholder');
                
                modalPhoto.src = photoUrl;
                modalPhoto.style.display = 'block';
                modalPhotoPlaceholder.style.display = 'none';
                console.log('‚úÖ Foto atualizada no modal');

                // Atualizar lista de alunos
                const studentIndex = students.findIndex(s => s.id === currentStudent.id);
                if (studentIndex !== -1) {
                    students[studentIndex].foto_url = photoUrl;
                    console.log('‚úÖ Foto atualizada na lista de alunos');
                }

                // Recarregar a lista de alunos para atualizar todos os cards
                console.log('üîÑ Recarregando lista de alunos...');
                
                // Mostrar loading nos cards
                const grid = document.getElementById('studentsGrid');
                grid.innerHTML = `
                    <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        Atualizando lista de alunos...
                    </div>
                `;
                
                await loadStudents();
                console.log('‚úÖ Lista de alunos recarregada');

                console.log('üéâ Processo de edi√ß√£o de foto conclu√≠do com sucesso!');
                
                // Mensagem de sucesso
                if (devicesSynced) {
                    alert('‚úÖ Foto atualizada com sucesso! Dispositivos sincronizados.');
                } else {
                    alert('‚úÖ Foto atualizada com sucesso!');
                }

            } catch (error) {
                console.error('‚ùå Erro no upload:', error);
                alert('‚ùå Erro ao fazer upload da foto: ' + error.message);
            } finally {
                // Restaurar bot√£o
                const editButton = document.querySelector('.modal-photo-edit');
                editButton.textContent = 'üì∑ Alterar Foto';
                editButton.disabled = false;
                
                // Limpar input
                event.target.value = '';
            }
        }



        // Fechar modal ao clicar fora
        document.getElementById('studentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });


        // Inicializar √≠cones Lucide
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>