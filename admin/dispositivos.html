<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dispositivos - Escola Log</title>
    <meta name="description" content="Gerenciamento de dispositivos do Escola Log - Cadastro, edi√ß√£o e controle completo">
    <meta name="theme-color" content="#3b82f6">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Escola Log">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Escola Log">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon e Icons -->
    <link rel="icon" type="image/png" href="../img/favicon.png">
    <link rel="apple-touch-icon" href="../img/metatag.png">
    <link rel="apple-touch-icon" sizes="192x192" href="../img/metatag.png">
    <link rel="apple-touch-icon" sizes="512x512" href="../img/metatag.png">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://escolalog.com/admin/dispositivos.html">
    <meta property="og:title" content="Dispositivos - Escola Log">
    <meta property="og:description" content="Gerenciamento de dispositivos do Escola Log - Cadastro, edi√ß√£o e controle completo">
    <meta property="og:image" content="../img/metatag.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://escolalog.com/admin/dispositivos.html">
    <meta name="twitter:title" content="Dispositivos - Escola Log">
    <meta name="twitter:description" content="Gerenciamento de dispositivos do Escola Log - Cadastro, edi√ß√£o e controle completo">
    <meta name="twitter:image" content="../img/metatag.png">
    
    <!-- Additional PWA Meta Tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --danger-color: #dc2626;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            margin: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary-color);
            margin: 0;
            padding: 0;
        }

        .nav-menu {
            display: flex;
            gap: 0.75rem;
            list-style: none;
            flex-wrap: wrap;
            margin: 0;
            padding: 0;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            color: var(--primary-color);
            background-color: #eff6ff;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            margin: 0;
            padding: 0;
        }

        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
            padding: 0;
            border: none;
        }

        .user-avatar:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            min-width: 150px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            margin-top: 0.5rem;
            margin-left: 0;
            margin-right: 0;
            margin-bottom: 0;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
            margin: 0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--background);
            color: var(--primary-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
        }

        .dropdown-item.logout:hover {
            background-color: #fef2f2;
            color: var(--danger-color);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            height: 44px;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--background);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            height: 36px;
            min-width: 80px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loading {
            position: relative;
            color: transparent;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-filters {
            background: var(--surface);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .data-table {
            background: var(--surface);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--background);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .table td {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .table tbody tr:hover {
            background: var(--background);
        }

        .student-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .student-photo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: var(--success-color);
        }

        .status-inactive {
            background: #fee2e2;
            color: var(--danger-color);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            border: 2px dashed var(--border);
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-upload:hover {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border);
        }

        .photo-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-secondary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Tabs Styles */
        .tabs-container {
            margin-bottom: 1.5rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: #eff6ff;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #eff6ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Users Tab Styles */
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .users-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .users-actions {
            display: flex;
            gap: 0.5rem;
        }

        .users-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--background);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid var(--border);
            min-width: 120px;
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .users-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
        }

        /* System Tab Styles */
        .system-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .system-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .system-actions {
            display: flex;
            gap: 0.5rem;
        }

        .system-info {
            margin-top: 1.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .info-card {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .info-card h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .info-value {
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* User Actions in Table */
        .user-actions {
            display: flex;
            gap: 0.25rem;
        }

        .user-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            height: auto;
        }

        /* User Photo Styles */
        .user-photo-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .user-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
            background: var(--background);
        }

        .user-photo:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .user-photo-loading {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-photo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb;
        }

        /* Search Styles */
        .users-search {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .search-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-filters {
            margin: 0.75rem 0 0.5rem 0;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
            user-select: none;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            position: relative;
            appearance: none;
            transition: all 0.2s;
        }

        .filter-checkbox input[type="checkbox"]:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .filter-checkbox input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .filter-checkbox:hover input[type="checkbox"] {
            border-color: #3b82f6;
        }

        .search-stats {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .search-stats.highlight {
            color: #3b82f6;
            font-weight: 600;
        }

        /* Modal de Edi√ß√£o de Usu√°rio - Estilo Simples */
        .user-edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .user-edit-modal.hidden {
            display: none;
        }

        .user-edit-modal .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .user-edit-modal .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .user-edit-modal .close-btn:hover {
            color: #333;
        }

        /* Advanced Tab Styles */
        .advanced-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .advanced-header h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .advanced-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .advanced-section {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .advanced-section h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .advanced-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Upload Tab Styles */
        .upload-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .upload-header h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .upload-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .upload-section {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .upload-section h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .alunos-preview {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 1rem;
            background: white;
        }

        .aluno-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }

        .aluno-item:last-child {
            border-bottom: none;
        }

        .aluno-item .aluno-info {
            flex: 1;
        }

        .aluno-item .aluno-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .aluno-item .aluno-id {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .upload-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .upload-progress {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e7ff;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            text-align: center;
        }

        .upload-results {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 0.5rem;
        }

        .upload-results h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .result-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .result-success {
            color: #16a34a;
        }

        .result-error {
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }

            .nav-menu {
                display: none;
            }

            .main-content {
                padding: 1rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }

            .table-container {
                font-size: 0.75rem;
            }

            .actions {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab-btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }

            .users-header,
            .system-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .users-actions,
            .system-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .users-stats {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="../img/logo-horizonal.png" alt="Escola Log" style="height: 2rem;">
            </div>
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="alunos.html">Alunos</a></li>
            
                    <li><a href="escolas.html">Escolas</a></li>
                    <li><a href="turmas.html">Turmas</a></li>
                    <li><a href="series.html">S√©ries</a></li>
                    <li><a href="dispositivos.html" class="active">Dispositivos</a></li>
                    <li><a href="logs.html">Logs</a></li>
                    <li><a href="usuarios.html">Usu√°rios</a></li>
                </ul>
            </nav>
            <div class="user-menu">
                <div class="user-avatar" onclick="toggleDropdown()">A</div>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="../login.html" class="dropdown-item logout" onclick="logout()">Sair</a>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Dispositivos</h1>
                <p class="page-subtitle">Gerenciamento completo dos dispositivos cadastrados</p>
            </div>
            <button class="btn btn-primary" onclick="openModal('add')">
                ‚ûï Novo Dispositivo
            </button>
        </div>

        <div class="search-filters">
            <div class="filters-grid">
                <div class="form-group">
                    <label class="form-label">Buscar por nome</label>
                    <input type="text" class="form-input" id="searchName" placeholder="Digite o nome do dispositivo..." onkeyup="filterDispositivos()">
                </div>
                <div class="form-group">
                    <label class="form-label">Escola</label>
                    <select class="form-input" id="filterSchool" onchange="filterDispositivos()">
                        <option value="">Todas as escolas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="filterStatus" onchange="filterDispositivos()">
                        <option value="">Todos os status</option>
                        <option value="ATIVO">Ativo</option>
                        <option value="INATIVO">Inativo</option>
                        <option value="MANUTENCAO">Manuten√ß√£o</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">
                <h3 class="table-title">Lista de Dispositivos</h3>
                <span id="dispositivosCount">0 dispositivos</span>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>IP</th>
                            <th>Escola</th>
                            <th>Status</th>
                            <th>Login</th>
                            <th>Monitor</th>
                            <th>Data de Cria√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="dispositivosTableBody">
                        <tr>
                            <td colspan="8" class="loading">Carregando dispositivos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal para Adicionar/Editar Dispositivo -->
    <div class="modal" id="dispositivoModal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Dispositivo</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tabs para navega√ß√£o -->
                <div class="tabs-container">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchTab('config')">‚öôÔ∏è Configura√ß√£o</button>
                        <button class="tab-btn" onclick="switchTab('users')">üë• Usu√°rios</button>
                        <button class="tab-btn" onclick="switchTab('system')">üìä Sistema</button>
                        <button class="tab-btn" onclick="switchTab('advanced')">üîß Avan√ßado</button>
                        <button class="tab-btn" onclick="switchTab('upload')">üì§ Subir em Massa</button>
                    </div>
                </div>

                <!-- Tab de Configura√ß√£o -->
                <div id="tab-config" class="tab-content active">
                    <form id="dispositivoForm">
                        <input type="hidden" id="dispositivoId">

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome do Dispositivo *</label>
                                <input type="text" class="form-input" id="nome" placeholder="Digite o nome do dispositivo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">IP *</label>
                                <input type="text" class="form-input" id="ip" placeholder="Ex: 192.168.1.100:9103" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Escola *</label>
                                <select class="form-input" id="escola_id" required>
                                    <option value="">Selecione uma escola</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-input" id="status">
                                    <option value="ATIVO">Ativo</option>
                                    <option value="INATIVO">Inativo</option>
                                    <option value="MANUTENCAO">Manuten√ß√£o</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Login *</label>
                                <input type="text" class="form-input" id="login" placeholder="Usu√°rio do dispositivo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Senha *</label>
                                <input type="password" class="form-input" id="senha" placeholder="Senha do dispositivo" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Device ID</label>
                                <input type="text" class="form-input" id="device_id" placeholder="ID do dispositivo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Monitor URL</label>
                                <input type="url" class="form-input" id="monitor" placeholder="URL do monitor">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Tab de Usu√°rios -->
                <div id="tab-users" class="tab-content">
                    <div class="users-header">
                        <h3>üë• Usu√°rios do Dispositivo</h3>
                        <div class="users-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadDeviceUsers()" id="loadUsersBtn">
                                üîÑ Carregar Usu√°rios
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="loadDeviceUsers(10)" id="loadUsersLimitBtn">
                                üî¢ Carregar 10
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="testModal()" id="testModalBtn">
                                üß™ Testar Modal
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="refreshUsers()" id="refreshUsersBtn">
                                üîÑ Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="users-stats" id="usersStats" style="display: none;">
                        <div class="stat-card">
                            <span class="stat-number" id="totalUsers">0</span>
                            <span class="stat-label">Total de Usu√°rios</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="activeUsers">0</span>
                            <span class="stat-label">Usu√°rios Ativos</span>
                        </div>
                    </div>
                    
                    <!-- Barra de Pesquisa -->
                    <div class="users-search" id="usersSearchContainer" style="display: none;">
                        <div class="search-input-group">
                            <input type="text" 
                                   id="userSearchInput" 
                                   placeholder="üîç Pesquisar por nome, matr√≠cula ou ID..." 
                                   class="search-input"
                                   onkeyup="filterUsers()">
                            <button class="btn btn-secondary btn-sm" onclick="clearSearch()" id="clearSearchBtn">
                                <span>Limpar</span>
                            </button>
                        </div>
                        <div class="search-filters">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="noPhotoFilter" onchange="filterUsers()">
                                <span class="checkmark"></span>
                                üì∑ Mostrar apenas usu√°rios sem foto
                            </label>
                        </div>
                        <div class="search-stats" id="searchStats">
                            <span id="searchResultsCount">0</span> usu√°rios encontrados
                        </div>
                    </div>

                    <div class="users-table-container">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>ID</th>
                                        <th>Matr√≠cula</th>
                                        <th>Nome</th>
                                        <th>Senha</th>
                                        <th>√öltimo Acesso</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="deviceUsersTableBody">
                                    <tr>
                                        <td colspan="7" class="loading">Clique em "Carregar Usu√°rios" para ver os dados</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab de Sistema -->
                <div id="tab-system" class="tab-content">
                    <div class="system-header">
                        <h3>üìä Informa√ß√µes do Sistema</h3>
                        <div class="system-actions">
                            <button class="btn btn-primary btn-sm" onclick="getSystemInfo()" id="systemInfoBtn">
                                üìä Obter Informa√ß√µes
                            </button>
                            <button class="btn btn-info btn-sm" onclick="testLambdaOnly()" id="testLambdaBtn">
                                üåê Testar Lambda
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="testConnection()" id="testConnectionBtn">
                                üîó Testar Conex√£o
                            </button>
                        </div>
                    </div>
                    
                    <div class="system-info" id="systemInfo" style="display: none;">
                        <div class="info-grid">
                            <div class="info-card">
                                <h4>üîß Informa√ß√µes Gerais</h4>
                                <div id="generalInfo"></div>
                            </div>
                            <div class="info-card">
                                <h4>üìà Estat√≠sticas</h4>
                                <div id="statsInfo"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab de Configura√ß√µes Avan√ßadas -->
                <div id="tab-advanced" class="tab-content">
                    <div class="advanced-header">
                        <h3>üîß Configura√ß√µes Avan√ßadas</h3>
                        <p class="text-sm text-gray-600">Configure par√¢metros avan√ßados do dispositivo</p>
                    </div>
                    
                    <div class="advanced-sections">
                        <!-- Configura√ß√£o do Monitor -->
                        <div class="advanced-section">
                            <h4>üì° Configura√ß√£o do Monitor</h4>
                            <div class="form-grid">
                                <div class="form-group form-grid-full">
                                    <label class="form-label">URL do Monitor *</label>
                                    <input type="url" class="form-input" id="monitorUrl" 
                                           placeholder="https://api.exemplo.com/monitor" required>
                                    <p class="text-sm text-gray-500 mt-1">
                                        URL completa do endpoint do monitor para sincroniza√ß√£o
                                    </p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Timeout (ms)</label>
                                    <input type="number" class="form-input" id="monitorTimeout" 
                                           value="5000" min="1000" max="30000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Porta</label>
                                    <input type="number" class="form-input" id="monitorPort" 
                                           value="443" min="1" max="65535">
                                </div>
                            </div>
                            <div class="advanced-actions">
                                <button class="btn btn-primary btn-sm" onclick="configureMonitor()" id="configureMonitorBtn">
                                    ‚öôÔ∏è Configurar Monitor
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="testMonitor()" id="testMonitorBtn">
                                    üîó Testar Monitor
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="getMonitorConfig()" id="getMonitorConfigBtn">
                                    üîé Buscar configura√ß√£o do dispositivo
                                </button>
                            </div>

                            <div class="monitor-current" style="margin-top: 10px;">
                                <p class="text-sm text-gray-600">Configura√ß√£o atual no equipamento:</p>
                                <div class="info-grid">
                                    <div class="info-card">
                                        <div class="info-row"><strong>Hostname:</strong> <span id="monitorHostname">-</span></div>
                                        <div class="info-row"><strong>Porta:</strong> <span id="monitorPortCurrent">-</span></div>
                                        <div class="info-row"><strong>Path:</strong> <span id="monitorPath">-</span></div>
                                        <div class="info-row"><strong>Timeout:</strong> <span id="monitorTimeoutCurrent">-</span></div>
                                        <div class="info-row"><strong>URL efetiva:</strong> <span id="monitorEffectiveUrl">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configura√ß√µes de Sincroniza√ß√£o -->
                        <div class="advanced-section">
                            <h4>üîÑ Sincroniza√ß√£o</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Intervalo de Sincroniza√ß√£o (min)</label>
                                    <input type="number" class="form-input" id="syncInterval" 
                                           value="5" min="1" max="60">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tentativas de Reconex√£o</label>
                                    <input type="number" class="form-input" id="retryAttempts" 
                                           value="3" min="1" max="10">
                                </div>
                            </div>
                            <div class="advanced-actions">
                                <button class="btn btn-primary btn-sm" onclick="configureSync()" id="configureSyncBtn">
                                    ‚öôÔ∏è Configurar Sincroniza√ß√£o
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="forceSync()" id="forceSyncBtn">
                                    üîÑ For√ßar Sincroniza√ß√£o
                                </button>
                            </div>
                        </div>

                        <!-- Configura√ß√µes de Log -->
                        <div class="advanced-section">
                            <h4>üìù Logs e Monitoramento</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">N√≠vel de Log</label>
                                    <select class="form-input" id="logLevel">
                                        <option value="ERROR">Erro</option>
                                        <option value="WARN">Aviso</option>
                                        <option value="INFO" selected>Informa√ß√£o</option>
                                        <option value="DEBUG">Debug</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reten√ß√£o de Logs (dias)</label>
                                    <input type="number" class="form-input" id="logRetention" 
                                           value="30" min="1" max="365">
                                </div>
                            </div>
                            <div class="advanced-actions">
                                <button class="btn btn-primary btn-sm" onclick="configureLogs()" id="configureLogsBtn">
                                    ‚öôÔ∏è Configurar Logs
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="downloadLogs()" id="downloadLogsBtn">
                                    üì• Baixar Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab de Upload de Alunos -->
                <div id="tab-upload" class="tab-content">
                    <div class="upload-header">
                        <h3>üì§ Upload de Alunos</h3>
                        <p class="text-sm text-gray-600">Selecione uma turma e envie todos os alunos para o dispositivo</p>
                    </div>
                    
                    <div class="upload-sections">
                        <!-- Sele√ß√£o de Turma -->
                        <div class="upload-section">
                            <h4>üéì Sele√ß√£o de Turma</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Escola</label>
                                    <select class="form-input" id="uploadEscola" onchange="loadTurmasForUpload()">
                                        <option value="">Selecione uma escola</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">S√©rie</label>
                                    <select class="form-input" id="uploadSerie" onchange="loadTurmasForUpload()">
                                        <option value="">Selecione uma s√©rie</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Turma *</label>
                                    <select class="form-input" id="uploadTurma" onchange="loadAlunosForUpload()" required>
                                        <option value="">Selecione uma turma</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Preview dos Alunos -->
                        <div class="upload-section">
                            <h4>üë• Alunos da Turma</h4>
                            <div class="form-group" style="margin-bottom:8px;">
                                <label class="form-label">Buscar alunos</label>
                                <input type="text" class="form-input" id="uploadAlunosSearch" placeholder="Digite nome ou matr√≠cula..." oninput="filterUploadAlunos()">
                            </div>
                            <div class="upload-actions" style="margin-bottom: 8px; display:flex; gap:8px;">
                                <button class="btn btn-secondary btn-sm" onclick="markAllAlunos()">Marcar todos</button>
                                <button class="btn btn-secondary btn-sm" onclick="unmarkAllAlunos()">Desmarcar todos</button>
                            </div>
                            <div id="alunosPreview" class="alunos-preview">
                                <p class="text-gray-500">Selecione uma turma para visualizar os alunos</p>
                            </div>
                        </div>

                        <!-- Configura√ß√µes de Upload -->
                        <div class="upload-section">
                            <h4>‚öôÔ∏è Configura√ß√µes de Upload</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">URL da Fun√ß√£o Lambda</label>
                                    <input type="url" class="form-input" id="lambdaUrl" placeholder="https://sua-lambda-url.amazonaws.com/upload" onchange="setUploadLambdaUrl(this.value)">
                                    <small class="text-gray-500">URL da fun√ß√£o Lambda para upload de alunos</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Modo de Upload</label>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="uploadDirectMode" />
                                        <label for="uploadDirectMode" class="text-gray-700">Usar upload direto via HTTP (sem Lambda)</label>
                                    </div>
                                    <small class="text-gray-500">Quando ativado, envia diretamente ao dispositivo usando http://IP:80</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Senha Padr√£o</label>
                                    <input type="text" class="form-input" id="uploadPassword" value="123456" placeholder="Senha padr√£o para os usu√°rios">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Grupo do Dispositivo</label>
                                    <input type="number" class="form-input" id="uploadGroupId" value="1" min="1" placeholder="ID do grupo no dispositivo">
                                </div>
                            </div>
                        </div>

                        <!-- A√ß√µes de Upload -->
                        <div class="upload-actions">
                            <button class="btn btn-primary" onclick="uploadAlunosToDevice()" id="uploadBtn" disabled>
                                üì§ Enviar Alunos para Dispositivo
                            </button>
                            <button class="btn btn-secondary" onclick="clearUploadForm()">
                                üîÑ Limpar Sele√ß√£o
                            </button>
                        </div>

                        <!-- Progress Bar -->
                        <div id="uploadProgress" class="upload-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">Preparando upload...</div>
                        </div>

                        <!-- Resultados -->
                        <div id="uploadResults" class="upload-results" style="display: none;">
                            <h4>üìä Resultados do Upload</h4>
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveDispositivo()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        let supabase = null;
        let dispositivos = [];
        let schools = [];
        let currentDispositivoId = null;
        let deviceUsers = [];
        let currentDevice = null;
        
        // URL da Lambda para opera√ß√µes de dispositivo
        const LAMBDA_URL = 'https://yfh5dmsuucx76bronca7f7k3le0sjykd.lambda-url.us-east-2.on.aws/';
        
        // Fun√ß√£o para buscar chaves do Supabase (sem chamadas externas)
        async function getSupabaseKeys() {
            // Evitar chamadas a Lambda por CORS e porque ela n√£o √© para consumo do painel
            console.log('üîë Usando chaves do Supabase locais/hardcoded...');
            return {
                url: 'https://sntyndufbxfzasnqvayc.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNudHluZHVmYnhmemFzbnF2YXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzQ2ODcsImV4cCI6MjA3MTc1MDY4N30.Pv9CaNkpo2HMMAtPbyLz2AdR8ZyK1jtHbP78pR5CPSM'
            };
        }
        
        // Fun√ß√£o para inicializar Supabase
        async function initializeSupabase() {
            const keys = await getSupabaseKeys();
            
            console.log('üîß Inicializando Supabase com:', {
                url: keys.url,
                key: keys.key ? 'Configurada' : 'N√£o configurada',
                keyType: keys.key?.includes('eyJ') ? 'JWT Token' : 'Unknown'
            });
            
            // Definir vari√°veis globais
            window.SUPABASE_URL = keys.url;
            window.SUPABASE_KEY = keys.key;
            
            // Configurar Supabase
            supabase = window.supabase.createClient(keys.url, keys.key);
            
            console.log('‚úÖ Supabase inicializado com sucesso');
            console.log('üîç Cliente Supabase:', {
                supabaseUrl: supabase.supabaseUrl,
                supabaseKey: supabase.supabaseKey ? 'Configurada' : 'N√£o configurada'
            });
            
            return supabase;
        }

        // Fun√ß√£o para carregar dispositivos
        async function loadDispositivos() {
            try {
                console.log('üì± Carregando dispositivos...');
                console.log('Supabase client:', supabase);
                
                // Consulta com joins para escolas
                const { data, error } = await supabase
                    .from('dispositivos')
                    .select(`
                        *,
                        escolas:escola_id(nome)
                    `)
                    .is('soft_delete', null)
                    .order('nome');

                console.log('Resultado da consulta de dispositivos:', { data, error });

                if (error) {
                    console.error('‚ùå Erro ao carregar dispositivos:', error);
                    showEmptyState('Erro ao carregar dispositivos: ' + error.message);
                    return;
                }

                if (!data || data.length === 0) {
                    console.log('‚ö†Ô∏è Nenhum dispositivo encontrado');
                    showEmptyState('Nenhum dispositivo encontrado');
                    return;
                }

                dispositivos = data;
                console.log(`‚úÖ ${dispositivos.length} dispositivos carregados:`, dispositivos);
                renderDispositivos(dispositivos);
                updateDispositivosCount(dispositivos.length);

            } catch (error) {
                console.error('‚ùå Erro ao carregar dispositivos:', error);
                showEmptyState('Erro ao carregar dispositivos: ' + error.message);
            }
        }

        // Fun√ß√£o para carregar escolas
        async function loadSchools() {
            try {
                console.log('üè´ Carregando escolas...');
                const { data, error } = await supabase
                    .from('escolas')
                    .select('id, nome')
                    .eq('soft_delete', false)
                    .order('nome');

                if (error) {
                    console.error('Erro ao carregar escolas:', error);
                    return;
                }

                schools = data || [];
                console.log(`‚úÖ ${schools.length} escolas carregadas`);

                // Popular select de escola no modal
                const escolaSelect = document.getElementById('escola_id');
                if (escolaSelect) {
                    escolaSelect.innerHTML = '<option value="">Selecione uma escola</option>';
                    schools.forEach(escola => {
                        const option = document.createElement('option');
                        option.value = escola.id;
                        option.textContent = escola.nome;
                        escolaSelect.appendChild(option);
                    });
                }

                // Popular filtro de escola
                const filterSchoolSelect = document.getElementById('filterSchool');
                if (filterSchoolSelect) {
                    filterSchoolSelect.innerHTML = '<option value="">Todas as escolas</option>';
                    schools.forEach(escola => {
                        const option = document.createElement('option');
                        option.value = escola.id;
                        option.textContent = escola.nome;
                        filterSchoolSelect.appendChild(option);
                    });
                }

                return schools;
            } catch (error) {
                console.error('‚ùå Erro ao carregar escolas:', error);
                return [];
            }
        }




        // Fun√ß√£o para mostrar loading em bot√£o
        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.disabled = true;
                button.classList.add('btn-loading');
                button.dataset.originalText = button.textContent;
                button.textContent = '';
            } else {
                button.disabled = false;
                button.classList.remove('btn-loading');
                button.textContent = button.dataset.originalText || button.textContent;
            }
        }

        // Fun√ß√£o para gerenciar loading de m√∫ltiplos bot√µes
        function setButtonsLoading(buttonIds, loading = true) {
            buttonIds.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    setButtonLoading(button, loading);
                }
            });
        }

        // Fun√ß√£o para renderizar dispositivos
        function renderDispositivos(dispositivosData) {
            const tbody = document.getElementById('dispositivosTableBody');
            
            if (!dispositivosData || dispositivosData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">üì±</div>
                            <p>Nenhum dispositivo encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = dispositivosData.map(dispositivo => {
                const escolaNome = dispositivo.escolas?.nome || '-';
                const statusBadge = dispositivo.status === 'ATIVO' ? 
                    '<span class="status-badge status-active">Ativo</span>' :
                    dispositivo.status === 'INATIVO' ? 
                    '<span class="status-badge status-inactive">Inativo</span>' :
                    '<span class="status-badge" style="background: #fef3c7; color: #d97706;">Manuten√ß√£o</span>';
                const createdDate = new Date(dispositivo.created_at).toLocaleDateString('pt-BR');
                
                return `
                    <tr>
                        <td><strong>${dispositivo.nome}</strong></td>
                        <td>${dispositivo.ip}</td>
                        <td>${escolaNome}</td>
                        <td>${statusBadge}</td>
                        <td>${dispositivo.login}</td>
                        <td>${dispositivo.monitor ? `<a href="${dispositivo.monitor}" target="_blank">${dispositivo.monitor}</a>` : '-'}</td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-secondary btn-sm" onclick="editDispositivo(${dispositivo.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteDispositivo(${dispositivo.id}, '${dispositivo.nome}')">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Fun√ß√£o para mostrar estado vazio
        function showEmptyState(message) {
            const tbody = document.getElementById('dispositivosTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        // Fun√ß√£o para atualizar contador
        function updateDispositivosCount(count) {
            document.getElementById('dispositivosCount').textContent = `${count} dispositivo${count !== 1 ? 's' : ''}`;
        }

        // Fun√ß√£o para filtrar dispositivos
        function filterDispositivos() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterSchool = document.getElementById('filterSchool').value;
            const filterStatus = document.getElementById('filterStatus').value;

            const filtered = dispositivos.filter(dispositivo => {
                const matchName = !searchName || dispositivo.nome.toLowerCase().includes(searchName);
                const matchSchool = !filterSchool || dispositivo.escola_id === filterSchool;
                const matchStatus = !filterStatus || dispositivo.status === filterStatus;

                return matchName && matchSchool && matchStatus;
            });

            renderDispositivos(filtered);
            updateDispositivosCount(filtered.length);
        }

        // Fun√ß√£o para abrir modal
        function openModal(mode, dispositivoId = null) {
            console.log('üîß Abrindo modal:', { mode, dispositivoId });
            const modal = document.getElementById('dispositivoModal');
            const title = document.getElementById('modalTitle');
            
            if (mode === 'add') {
                title.textContent = 'Novo Dispositivo';
                clearForm();
            } else if (mode === 'edit') {
                title.textContent = 'Editar Dispositivo';
                loadDispositivoData(dispositivoId);
            }
            
            currentDispositivoId = dispositivoId;
            modal.classList.add('show');
            console.log('‚úÖ Modal aberto com sucesso');
        }

        // Fun√ß√£o para fechar modal
        function closeModal() {
            const modal = document.getElementById('dispositivoModal');
            modal.classList.remove('show');
            clearForm();
            currentDispositivoId = null;
            currentDevice = null;
            deviceUsers = [];
            
            // Limpar dados das tabs
            document.getElementById('usersStats').style.display = 'none';
            document.getElementById('systemInfo').style.display = 'none';
            document.getElementById('deviceUsersTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="loading">Clique em "Carregar Usu√°rios" para ver os dados</td>
                </tr>
            `;
            
            // Voltar para a tab de configura√ß√£o
            switchTab('config');
        }

        // Fun√ß√£o para limpar formul√°rio
        function clearForm() {
            document.getElementById('dispositivoForm').reset();
            document.getElementById('dispositivoId').value = '';
        }

        // Fun√ß√£o para carregar dados do dispositivo
        async function loadDispositivoData(dispositivoId) {
            try {
                console.log('üîç Carregando dados do dispositivo:', dispositivoId);
                console.log('üìä Dispositivos dispon√≠veis:', dispositivos);
                
                const dispositivo = dispositivos.find(d => d.id == dispositivoId);
                console.log('üì± Dispositivo encontrado:', dispositivo);
                
                if (!dispositivo) {
                    console.error('‚ùå Dispositivo n√£o encontrado com ID:', dispositivoId);
                    alert('Dispositivo n√£o encontrado');
                    return;
                }

                // Armazenar dispositivo atual para uso nas tabs
                currentDevice = dispositivo;

                // Preencher campos do formul√°rio
                document.getElementById('dispositivoId').value = dispositivo.id;
                document.getElementById('nome').value = dispositivo.nome || '';
                document.getElementById('ip').value = dispositivo.ip || '';
                document.getElementById('escola_id').value = dispositivo.escola_id || '';
                document.getElementById('status').value = dispositivo.status || 'ATIVO';
                document.getElementById('login').value = dispositivo.login || '';
                document.getElementById('senha').value = dispositivo.senha || '';
                document.getElementById('device_id').value = dispositivo.device_id || '';
                document.getElementById('monitor').value = dispositivo.monitor || '';

                // Preencher dados da tab avan√ßada
                if (dispositivo.monitor) {
                    document.getElementById('monitorUrl').value = dispositivo.monitor;
                }

                console.log('‚úÖ Dados do dispositivo carregados no formul√°rio');

                // Buscar configura√ß√£o atual do monitor diretamente do equipamento
                try {
                    await getMonitorConfig();
                } catch (e) {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter configura√ß√£o do monitor do dispositivo:', e);
                }

            } catch (error) {
                console.error('Erro ao carregar dados do dispositivo:', error);
                alert('Erro ao carregar dados do dispositivo');
            }
        }

        // Fun√ß√£o para alternar entre tabs
        function switchTab(tabName) {
            // Remover classe active de todas as tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar tab selecionada
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            console.log(`üìë Tab ${tabName} ativada`);
        }

        // Fun√ß√£o para carregar usu√°rios do dispositivo via Lambda
        async function loadDeviceUsers(limit = null) {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const loadBtn = document.getElementById('loadUsersBtn');
            const limitBtn = document.getElementById('loadUsersLimitBtn');
            setButtonLoading(loadBtn, true);
            setButtonLoading(limitBtn, true);

            try {
                console.log('üë• Carregando usu√°rios do dispositivo:', currentDevice);
                if (limit) {
                    console.log(`üìä Limite de usu√°rios: ${limit}`);
                }
                
                const payload = {
                    action: 'load_users',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha
                };

                // Adicionar limite se especificado
                if (limit) {
                    payload.limit = limit;
                }

                console.log('üì§ Enviando requisi√ß√£o para Lambda:', payload);

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì• [loadDeviceUsers] Resposta da Lambda recebida:', {
                    status: data.status,
                    message: data.message,
                    hasData: !!data.data,
                    hasUsers: !!(data.data && data.data.users),
                    usersCount: data.data && data.data.users ? data.data.users.length : 0
                });
                console.log('üìä [loadDeviceUsers] Dados completos da resposta:', JSON.stringify(data, null, 2));
                
                // Verificar se a mensagem cont√©m "Configura√ß√µes"
                if (data.message && data.message.includes('Configura√ß√µes')) {
                    console.error('üö® [loadDeviceUsers] DETECTADA MENSAGEM SUSPEITA:', data.message);
                    console.error('üö® [loadDeviceUsers] Esta mensagem pode estar vindo de outra fun√ß√£o ou processo!');
                    console.error('üö® [loadDeviceUsers] Stack trace atual:', new Error().stack);
                }

                if (data.status === 'success' && data.data && data.data.users) {
                    deviceUsers = data.data.users;
                    deviceUsers.session = data.data.session; // Armazenar sess√£o para fotos
                    await renderDeviceUsers(deviceUsers);
                    updateUsersStats(deviceUsers);
                    document.getElementById('usersStats').style.display = 'flex';
                    document.getElementById('usersSearchContainer').style.display = 'block';
                    console.log(`‚úÖ ${deviceUsers.length} usu√°rios carregados`);
                } else if (data.status === 'success') {
                    // Lambda retornou sucesso mas sem dados de usu√°rios
                    console.warn('‚ö†Ô∏è Lambda retornou sucesso mas sem dados de usu√°rios:', data);
                    throw new Error(`Resposta inesperada da Lambda: ${data.message || 'Dados de usu√°rios n√£o encontrados'}`);
                } else {
                    // Lambda retornou erro
                    console.error('‚ùå Lambda retornou erro:', data);
                    throw new Error(data.message || data.error || 'Erro ao carregar usu√°rios');
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                alert('Erro ao carregar usu√°rios: ' + error.message);
                showUsersError('Erro ao carregar usu√°rios: ' + error.message);
            } finally {
                setButtonLoading(loadBtn, false);
                setButtonLoading(limitBtn, false);
            }
        }

        // Fun√ß√£o para renderizar usu√°rios do dispositivo
        async function renderDeviceUsers(users) {
            const tbody = document.getElementById('deviceUsersTableBody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>Nenhum usu√°rio encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Renderizar estrutura b√°sica primeiro
            tbody.innerHTML = users.map(user => {
                const lastAccess = user.last_access ? 
                    new Date(user.last_access * 1000).toLocaleString('pt-BR') : 
                    'Nunca';
                
                return `
                    <tr id="user-row-${user.id}">
                        <td>
                            <div class="user-photo-container">
                                <div class="user-photo-loading">
                                    <div class="loading-spinner !w-6 !h-6"></div>
                                </div>
                            </div>
                        </td>
                        <td>${user.id}</td>
                        <td>${user.registration}</td>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.password}</td>
                        <td>${lastAccess}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn btn-secondary btn-sm" onclick="editUser(${user.id})" title="Editar usu√°rio">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.name}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Carregar fotos de forma ass√≠ncrona (limitado a 3 por vez)
            const loadPhotosInBatches = async (users, batchSize = 3) => {
                for (let i = 0; i < users.length; i += batchSize) {
                    const batch = users.slice(i, i + batchSize);
                    const promises = batch.map(async (user) => {
                        try {
                            const photoUrl = await loadUserPhoto(user.id);
                            const photoContainer = document.querySelector(`#user-row-${user.id} .user-photo-container`);
                            
                            if (photoUrl) {
                                photoContainer.innerHTML = `
                                    <img src="${photoUrl}" 
                                         alt="Foto de ${user.name}" 
                                         class="user-photo" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNmM2Y0ZjYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDNi43OTA4NiA0IDUgNS43OTA4NiA1IDhDNSAxMC4yMDkxIDYuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSIjOWNhM2FmIi8+CjxwYXRoIGQ9Ik0xMiAxNEM4LjY4NjI5IDE0IDYgMTYuNjg2MyA2IDIwSDZWMjBIMThWMjBIMThDMTggMTYuNjg2MyAxNS4zMTM3IDE0IDEyIDE0WiIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4KPC9zdmc+'; this.onerror=null;">
                                `;
                            } else {
                                photoContainer.innerHTML = `
                                    <div class="user-photo-placeholder">
                                        <i class="ph ph-user text-2xl text-gray-400"></i>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.warn(`Erro ao carregar foto do usu√°rio ${user.id}:`, error);
                            const photoContainer = document.querySelector(`#user-row-${user.id} .user-photo-container`);
                            photoContainer.innerHTML = `
                                <div class="user-photo-placeholder">
                                    <i class="ph ph-user text-2xl text-gray-400"></i>
                                </div>
                            `;
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    // Pequena pausa entre lotes para n√£o sobrecarregar o dispositivo
                    if (i + batchSize < users.length) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            };

            await loadPhotosInBatches(users);
        }

        // Fun√ß√£o para gerar URL da foto do usu√°rio
        function generateUserPhotoUrl(user) {
            if (!currentDevice || !currentDevice.ip) {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNmM2Y0ZjYiLz4KPC9zdmc+';
            }
            
            // Construir URL da foto baseada no IP do dispositivo e ID do usu√°rio
            const deviceIp = currentDevice.ip.includes(':') ? currentDevice.ip : `${currentDevice.ip}:80`;
            return `http://${deviceIp}/photo.fcgi?session=${deviceUsers.session || ''}&user_id=${user.id}`;
        }

        // Fun√ß√£o para carregar foto do usu√°rio do dispositivo
        async function loadUserPhoto(userId) {
            if (!currentDevice) {
                return null;
            }

            try {
                // Obter nova sess√£o para cada foto
                const session = await getDeviceSession(
                    currentDevice.ip,
                    currentDevice.login || 'admin',
                    currentDevice.senha || 'admin'
                );

                const deviceIp = currentDevice.ip.includes(':') ? currentDevice.ip : `${currentDevice.ip}:80`;
                const response = await fetch(`http://${deviceIp}/user_get_image.fcgi?session=${session}&user_id=${userId}`);
                
                if (response.ok) {
                    const imageBlob = await response.blob();
                    return URL.createObjectURL(imageBlob);
                }
                return null;
            } catch (error) {
                console.warn(`Erro ao carregar foto do usu√°rio ${userId}:`, error);
                return null;
            }
        }

        // Fun√ß√£o para atualizar estat√≠sticas dos usu√°rios
        function updateUsersStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.last_access > 0).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
        }

        // Fun√ß√£o para filtrar usu√°rios
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase().trim();
            const noPhotoFilter = document.getElementById('noPhotoFilter').checked;
            const tbody = document.getElementById('deviceUsersTableBody');
            const rows = tbody.querySelectorAll('tr[id^="user-row-"]');
            let visibleCount = 0;

            rows.forEach(row => {
                const userId = row.id.replace('user-row-', '');
                const user = deviceUsers.find(u => u.id == userId);
                
                if (!user) return;

                // Verificar se corresponde ao termo de pesquisa
                const matchesSearch = !searchTerm || 
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.registration && user.registration.toLowerCase().includes(searchTerm)) ||
                    (user.id && user.id.toString().includes(searchTerm));

                // Verificar se corresponde ao filtro de foto
                let matchesPhotoFilter = true;
                if (noPhotoFilter) {
                    // Verificar se o usu√°rio n√£o tem foto
                    const photoCell = row.querySelector('td:first-child');
                    const hasPhoto = photoCell && photoCell.querySelector('img') && 
                                   photoCell.querySelector('img').src && 
                                   !photoCell.querySelector('img').src.includes('placeholder') &&
                                   !photoCell.querySelector('img').src.includes('default');
                    matchesPhotoFilter = !hasPhoto;
                }

                if (matchesSearch && matchesPhotoFilter) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Atualizar contador de resultados
            const searchStats = document.getElementById('searchStats');
            const searchResultsCount = document.getElementById('searchResultsCount');
            
            searchResultsCount.textContent = visibleCount;
            
            if (searchTerm || noPhotoFilter) {
                searchStats.classList.add('highlight');
            } else {
                searchStats.classList.remove('highlight');
            }
        }

        // Fun√ß√£o para limpar pesquisa
        function clearSearch() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('noPhotoFilter').checked = false;
            filterUsers();
        }

        // Fun√ß√£o para testar modal
        function testModal() {
            console.log('üß™ Testando modal...');
            
            // Criar modal se n√£o existir
            let modal = document.getElementById('userEditModal');
            if (!modal) {
                console.log('üìù Criando modal de teste');
                modal = createUserEditModal();
                document.body.appendChild(modal);
            }

            // Preencher com dados de teste
            document.getElementById('editUserId').value = 'TESTE';
            document.getElementById('editUserName').value = 'Usu√°rio de Teste';
            document.getElementById('editUserRegistration').value = '12345';
            document.getElementById('editUserPassword').value = '123456';

            // Mostrar modal
            console.log('üëÅÔ∏è Mostrando modal de teste');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            
            // Verificar visibilidade
            setTimeout(() => {
                const isVisible = modal.offsetParent !== null;
                console.log('üîç Modal de teste vis√≠vel:', isVisible);
                if (!isVisible) {
                    console.error('‚ùå Modal de teste n√£o est√° vis√≠vel!');
                    alert('Modal n√£o est√° vis√≠vel! Verifique o console para detalhes.');
                } else {
                    console.log('‚úÖ Modal de teste funcionando!');
                }
            }, 100);
        }

        // Fun√ß√£o para mostrar erro na tabela de usu√°rios
        function showUsersError(message) {
            const tbody = document.getElementById('deviceUsersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>${message}</p>
                    </td>
                </tr>
            `;
        }

        // Fun√ß√£o para atualizar usu√°rios
        function refreshUsers() {
            if (deviceUsers.length > 0) {
                loadDeviceUsers();
            } else {
                alert('Carregue os usu√°rios primeiro');
            }
        }

        // Fun√ß√£o para obter informa√ß√µes do sistema
        async function getSystemInfo() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const systemBtn = document.getElementById('systemInfoBtn');
            setButtonLoading(systemBtn, true);

            try {
                console.log('üìä Obtendo informa√ß√µes do sistema:', currentDevice);
                
                const payload = {
                    action: 'get_system_info',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha
                };

                console.log('üì§ Enviando requisi√ß√£o para Lambda:', payload);

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                // N√£o logar resposta da Lambda

                if (data.status === 'success' && data.data) {
                    renderSystemInfo(data.data);
                    document.getElementById('systemInfo').style.display = 'block';
                    console.log('‚úÖ Informa√ß√µes do sistema carregadas');
                } else {
                    throw new Error(data.message || 'Erro ao obter informa√ß√µes do sistema');
                }

            } catch (error) {
                console.error('‚ùå Erro ao obter informa√ß√µes do sistema:', error);
                alert('Erro ao obter informa√ß√µes do sistema: ' + error.message);
            } finally {
                setButtonLoading(systemBtn, false);
            }
        }

        // Fun√ß√£o para renderizar informa√ß√µes do sistema
        function renderSystemInfo(systemData) {
            const generalInfo = document.getElementById('generalInfo');
            const statsInfo = document.getElementById('statsInfo');

            // Informa√ß√µes gerais
            generalInfo.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value">${systemData.status || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Vers√£o:</span>
                    <span class="info-value">${systemData.version || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Modelo:</span>
                    <span class="info-value">${systemData.model || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Serial:</span>
                    <span class="info-value">${systemData.serial || 'N/A'}</span>
                </div>
            `;

            // Estat√≠sticas
            statsInfo.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Total de Usu√°rios:</span>
                    <span class="info-value">${systemData.total_users || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Usu√°rios Ativos:</span>
                    <span class="info-value">${systemData.active_users || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">√öltima Sincroniza√ß√£o:</span>
                    <span class="info-value">${systemData.last_sync || 'N/A'}</span>
                </div>
            `;
        }

        // Fun√ß√£o para testar conectividade b√°sica com Lambda
        async function testLambdaConnectivity() {
            try {
                console.log('üîó Testando conectividade b√°sica com Lambda URL:', LAMBDA_URL);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'ping' }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                
                console.log('üì• Resposta da Lambda - Status:', response.status);
                
                if (response.ok) {
                    console.log('‚úÖ Lambda URL est√° acess√≠vel');
                    return true;
                } else {
                    console.error('‚ùå Lambda retornou erro:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao testar Lambda:', error);
                return false;
            }
        }

        // Fun√ß√£o para testar apenas a Lambda
        async function testLambdaOnly() {
            const testBtn = document.getElementById('testLambdaBtn');
            setButtonLoading(testBtn, true);

            try {
                console.log('üåê Testando apenas conectividade com Lambda...');
                
                const lambdaAccessible = await testLambdaConnectivity();
                
                if (lambdaAccessible) {
                    alert('‚úÖ Lambda URL est√° acess√≠vel e funcionando!\n\nURL: ' + LAMBDA_URL);
                } else {
                    alert('‚ùå Lambda URL n√£o est√° acess√≠vel.\n\nVerifique:\n- Sua conex√£o com a internet\n- Se a URL est√° correta\n- Se o servi√ßo est√° funcionando');
                }
            } catch (error) {
                console.error('‚ùå Erro ao testar Lambda:', error);
                alert('‚ùå Erro ao testar Lambda: ' + error.message);
            } finally {
                setButtonLoading(testBtn, false);
            }
        }

        // Fun√ß√£o para testar conex√£o
        async function testConnection() {
            if (!currentDevice) {
                alert('‚ùå Nenhum dispositivo selecionado. Por favor, selecione um dispositivo primeiro.');
                return;
            }

            // Validar campos obrigat√≥rios
            if (!currentDevice.ip) {
                alert('‚ùå IP do dispositivo n√£o informado. Por favor, configure o IP do dispositivo.');
                return;
            }

            if (!currentDevice.login) {
                alert('‚ùå Login do dispositivo n√£o informado. Por favor, configure o login do dispositivo.');
                return;
            }

            if (!currentDevice.senha) {
                alert('‚ùå Senha do dispositivo n√£o informada. Por favor, configure a senha do dispositivo.');
                return;
            }

            const testBtn = document.getElementById('testConnectionBtn');
            setButtonLoading(testBtn, true);

            try {
                console.log('üîó Iniciando teste de conex√£o...');
                
                // Primeiro, testar conectividade b√°sica com Lambda
                console.log('üåê Verificando conectividade com Lambda...');
                const lambdaAccessible = await testLambdaConnectivity();
                
                if (!lambdaAccessible) {
                    throw new Error('Lambda URL n√£o est√° acess√≠vel. Verifique sua conex√£o com a internet e se a URL est√° correta.');
                }
                console.log('üì± Dispositivo:', {
                    id: currentDevice.id,
                    nome: currentDevice.nome,
                    ip: currentDevice.ip,
                    login: currentDevice.login,
                    status: currentDevice.status
                });
                
                const payload = {
                    action: 'test',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha
                };

                console.log('üì§ Enviando requisi√ß√£o para Lambda URL:', LAMBDA_URL);
                console.log('üì¶ Payload:', { ...payload, password: '***' }); // N√£o logar senha

                // Adicionar timeout de 30 segundos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('üì• Resposta recebida - Status:', response.status);

                if (!response.ok) {
                    let errorMessage = `Erro HTTP ${response.status}`;
                    
                    if (response.status === 404) {
                        errorMessage = 'Lambda URL n√£o encontrada (404). Verifique se a URL est√° correta.';
                    } else if (response.status === 403) {
                        errorMessage = 'Acesso negado (403). Verifique as permiss√µes da Lambda.';
                    } else if (response.status === 500) {
                        errorMessage = 'Erro interno do servidor (500). Verifique os logs da Lambda.';
                    } else if (response.status === 502) {
                        errorMessage = 'Bad Gateway (502). A Lambda pode estar indispon√≠vel.';
                    } else if (response.status === 503) {
                        errorMessage = 'Servi√ßo indispon√≠vel (503). Tente novamente em alguns minutos.';
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('üìã Dados da resposta:', data);

                if (data.status === 'success') {
                    console.log('‚úÖ Conex√£o bem-sucedida!');
                    alert('‚úÖ Conex√£o com o dispositivo bem-sucedida!\n\nDispositivo respondeu corretamente.');
                } else {
                    const errorMsg = data.message || data.error || 'Erro desconhecido na conex√£o';
                    console.error('‚ùå Falha na conex√£o:', errorMsg);
                    throw new Error(`Falha na conex√£o: ${errorMsg}`);
                }

            } catch (error) {
                console.error('‚ùå Erro ao testar conex√£o:', error);
                
                let userMessage = 'Erro ao testar conex√£o: ';
                
                if (error.name === 'AbortError') {
                    userMessage += 'Timeout - A conex√£o demorou mais de 30 segundos para responder.';
                } else if (error.message.includes('Failed to fetch')) {
                    userMessage += 'N√£o foi poss√≠vel conectar com o servidor. Verifique sua conex√£o com a internet.';
                } else if (error.message.includes('NetworkError')) {
                    userMessage += 'Erro de rede. Verifique sua conex√£o com a internet.';
                } else {
                    userMessage += error.message;
                }
                
                alert('‚ùå ' + userMessage);
            } finally {
                setButtonLoading(testBtn, false);
            }
        }

        // Fun√ß√µes para gerenciar usu√°rios
        async function editUser(userId) {
            console.log('üîß Fun√ß√£o editUser chamada para ID:', userId);
            console.log('üë• Usu√°rios dispon√≠veis:', deviceUsers);
            
            const user = deviceUsers.find(u => u.id === userId);
            if (!user) {
                console.error('‚ùå Usu√°rio n√£o encontrado para ID:', userId);
                alert('Usu√°rio n√£o encontrado');
                return;
            }

            console.log('‚úÖ Usu√°rio encontrado:', user);
            // Abrir modal de edi√ß√£o
            await openUserEditModal(user);
        }

        function deleteUser(userId, userName) {
            if (confirm(`Tem certeza que deseja excluir o usu√°rio "${userName}"?`)) {
                deleteUserFromDevice(userId, userName);
            }
        }

        // Fun√ß√µes para configura√ß√µes avan√ßadas
        async function configureMonitor() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const configureBtn = document.getElementById('configureMonitorBtn');
            setButtonLoading(configureBtn, true);

            try {
                const rawUrlInput = (document.getElementById('monitorUrl').value || '').replace(/`/g, '').trim();
                const timeoutInput = document.getElementById('monitorTimeout').value;
                const portInput = document.getElementById('monitorPort').value;

                if (!rawUrlInput) {
                    alert('URL do monitor √© obrigat√≥ria');
                    return;
                }

                // Parse da URL para extrair hostname com protocolo e path
                let urlObj;
                try { urlObj = new URL(rawUrlInput); } catch (e) {
                    alert('URL do monitor inv√°lida');
                    return;
                }
                const hostnameWithProtocol = `${urlObj.protocol}//${urlObj.hostname}`;
                // For√ßar path "/log" conforme especifica√ß√£o do monitor
                const pathStr = '/log';
                const portStr = String(portInput || (urlObj.port || (urlObj.protocol === 'https:' ? '443' : '80')));
                const timeoutStr = String(timeoutInput || '5000');

                console.log('üîß Configurando monitor (direto no dispositivo):', {
                    hostname: hostnameWithProtocol,
                    path: pathStr,
                    port: portStr,
                    request_timeout: timeoutStr
                });

                // Obter sess√£o usando IP+porta do cadastro
                const ipRaw = (currentDevice.ip || '').trim();
                const deviceLoginAddr = ipRaw.replace(/\/$/, ''); // ex: 170.238.212.153:8000
                const session = await getDeviceSession(
                    deviceLoginAddr,
                    currentDevice.login || 'admin',
                    currentDevice.senha || 'admin'
                );

                // Montar URL para set_configuration.fcgi
                const deviceHost = deviceLoginAddr;
                const url = `http://${deviceHost}/set_configuration.fcgi?session=${session}`;

                // Payload id√™ntico ao curl do Postman (valores como strings)
                const monitorPayload = {
                    monitor: {
                        request_timeout: timeoutStr,
                        hostname: hostnameWithProtocol,
                        port: portStr,
                        path: pathStr
                    }
                };

                let response;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(monitorPayload),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (err) {
                    const msg = (err && err.message || '').toLowerCase();
                    if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                        // Usar proxy local para contornar CORS e replicar headers do curl
                        response = await fetch('http://localhost:3001/proxy/fcgi', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                targetUrl: url,
                                payload: monitorPayload,
                                headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                            })
                        });
                    } else {
                        throw err;
                    }
                }

                // Se sess√£o inv√°lida (HTTP), renovar e tentar novamente
                if (response && (response.status === 401 || response.status === 403)) {
                    console.warn('Sess√£o inv√°lida ao configurar monitor; tentando renovar sess√£o...');
                    const newSession = await getDeviceSession(
                        deviceLoginAddr,
                        currentDevice.login || 'admin',
                        currentDevice.senha || 'admin'
                    );
                    const retryUrl = `http://${deviceHost}/set_configuration.fcgi?session=${newSession}`;
                    try {
                        const controller2 = new AbortController();
                        const timeoutId2 = setTimeout(() => controller2.abort(), 3000);
                        response = await fetch(retryUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(monitorPayload),
                            signal: controller2.signal
                        });
                        clearTimeout(timeoutId2);
                    } catch (err) {
                        const msg = (err && err.message || '').toLowerCase();
                        if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                            response = await fetch('http://localhost:3001/proxy/fcgi', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    targetUrl: retryUrl,
                                    payload: monitorPayload,
                                    headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                                })
                            });
                        } else {
                            throw err;
                        }
                    }
                }

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP error! status: ${response.status}`);
                }

                let data;
                try { data = await response.json(); } catch (_) { data = {}; }
                if (data && (data.error || data.code)) {
                    if ((data.error || '').toLowerCase().includes('invalid session') || data.code === 1) {
                        console.warn('Sess√£o inv√°lida (JSON) ao configurar; tentando renovar...');
                        const newSession = await getDeviceSession(
                            deviceLoginAddr,
                            currentDevice.login || 'admin',
                            currentDevice.senha || 'admin'
                        );
                        const retryUrl = `http://${deviceHost}/set_configuration.fcgi?session=${newSession}`;
                        let retryResp;
                        try {
                            retryResp = await fetch(retryUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(monitorPayload)
                            });
                        } catch (err) {
                            const msg = (err && err.message || '').toLowerCase();
                            if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                                retryResp = await fetch('http://localhost:3001/proxy/fcgi', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        targetUrl: retryUrl,
                                        payload: monitorPayload,
                                        headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                                    })
                                });
                            } else {
                                throw err;
                            }
                        }
                        if (!retryResp.ok) {
                            const text = await retryResp.text();
                            throw new Error(text || `HTTP error! status: ${retryResp.status}`);
                        }
                        try { data = await retryResp.json(); } catch (_) { data = {}; }
                        if (data && (data.error || data.code)) {
                            throw new Error(data.error || 'Erro ao configurar monitor');
                        }
                    } else {
                        throw new Error(data.error || 'Erro ao configurar monitor');
                    }
                }

                alert('‚úÖ Monitor configurado com sucesso!');
                // Persistir a URL do monitor no registro do dispositivo
                try {
                    const updateResult = await supabase
                        .from('dispositivos')
                        .update({ monitor: rawUrlInput })
                        .eq('id', currentDevice.id);

                    if (updateResult.error) {
                        console.warn('‚ö†Ô∏è Monitor configurado no dispositivo, mas falhou ao salvar no banco:', updateResult.error);
                    } else {
                        // Atualizar UI e estado local
                        currentDevice.monitor = rawUrlInput;
                        const monitorInput = document.getElementById('monitor');
                        if (monitorInput) monitorInput.value = rawUrlInput;
                        // Recarregar a lista para refletir a coluna Monitor
                        loadDispositivos();
                    }
                } catch (persistError) {
                    console.warn('‚ö†Ô∏è Erro ao persistir monitor no banco:', persistError);
                }

            } catch (error) {
                console.error('‚ùå Erro ao configurar monitor:', error);
                alert('‚ùå Erro ao configurar monitor: ' + error.message);
            } finally {
                setButtonLoading(configureBtn, false);
            }
        }

        async function testMonitor() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const testBtn = document.getElementById('testMonitorBtn');
            setButtonLoading(testBtn, true);

            try {
                console.log('üîó Testando monitor:', currentDevice);

                const payload = {
                    action: 'test_monitor',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha
                };

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì• Resposta do teste:', data);

                if (data.status === 'success') {
                    alert('‚úÖ Monitor funcionando corretamente!');
                } else {
                    throw new Error(data.message || 'Erro no teste do monitor');
                }

            } catch (error) {
                console.error('‚ùå Erro ao testar monitor:', error);
                alert('‚ùå Erro ao testar monitor: ' + error.message);
            } finally {
                setButtonLoading(testBtn, false);
            }
        }

        // Fun√ß√£o para buscar configura√ß√£o atual do monitor no equipamento (direto via FCGI, com fallback Lambda)
        async function getMonitorConfig() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const fetchBtn = document.getElementById('getMonitorConfigBtn');
            setButtonLoading(fetchBtn, true);
            console.log('üîß [getMonitorConfig] Iniciando obten√ß√£o de configura√ß√£o do monitor', {
                device: currentDevice,
                time: new Date().toISOString()
            });

            const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };

            try {
                console.log('üîé Buscando configura√ß√£o de monitor no dispositivo (direto):', currentDevice);

                // 1) Normalizar IPs: usar IP+porta do cadastro tanto para login quanto para get_configuration
                const ipRaw = (currentDevice.ip || '').trim();
                const deviceLoginAddr = ipRaw.replace(/\/$/, ''); // ex: 170.238.212.153:8000
                const session = await getDeviceSession(
                    deviceLoginAddr,
                    currentDevice.login || 'admin',
                    currentDevice.senha || 'admin'
                );

                // 2) Montar URL usando a porta configurada no dispositivo (get_configuration.fcgi)
                const deviceHost = deviceLoginAddr;
                const url = `http://${deviceHost}/get_configuration.fcgi?session=${session}`;

                // 3) Realizar chamada com payload solicitando apenas o bloco "monitor"
                const monitorPayload = {
                    monitor: [
                        'request_timeout',
                        'hostname',
                        'port',
                        'path'
                    ]
                };

                // Adicionar timeout curto. Se falhar por CORS, usar proxy local (localhost:3000)
                let response;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(monitorPayload),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (err) {
                    const msg = (err && err.message || '').toLowerCase();
                    if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                        const proxyResp = await fetch('http://localhost:3001/proxy/fcgi', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                targetUrl: url,
                                payload: monitorPayload,
                                headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                            })
                        });
                        response = proxyResp;
                    } else {
                        throw err;
                    }
                }

                // Se a sess√£o for inv√°lida, tentar renovar e refazer uma vez
                if (response.status === 401 || response.status === 403) {
                    console.warn('Sess√£o inv√°lida ao buscar configura√ß√£o; tentando renovar sess√£o...');
                    const newSession = await getDeviceSession(
                        deviceLoginAddr,
                        currentDevice.login || 'admin',
                        currentDevice.senha || 'admin'
                    );
                    const retryUrl = `http://${deviceHost}/get_configuration.fcgi?session=${newSession}`;
                    try {
                        const controller2 = new AbortController();
                        const timeoutId2 = setTimeout(() => controller2.abort(), 3000);
                        response = await fetch(retryUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(monitorPayload),
                            signal: controller2.signal
                        });
                        clearTimeout(timeoutId2);
                    } catch (err) {
                        const msg = (err && err.message || '').toLowerCase();
                        if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                            const proxyResp = await fetch('http://localhost:3001/proxy/fcgi', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    targetUrl: retryUrl,
                                    payload: monitorPayload,
                                    headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                                })
                            });
                            response = proxyResp;
                        } else {
                            throw err;
                        }
                    }
                }

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP error! status: ${response.status}`);
                }

                let cfg = await response.json();
                // Alguns dispositivos retornam { error, code } em caso de falha
                if (cfg && (cfg.error || cfg.code)) {
                    // Se a sess√£o for inv√°lida, tentar renovar e refazer uma vez
                    if ((cfg.error || '').toLowerCase().includes('invalid session')) {
                        console.warn('Sess√£o inv√°lida (JSON) ao buscar configura√ß√£o; tentando renovar sess√£o...');
                        const newSession = await getDeviceSession(
                            deviceLoginAddr,
                            currentDevice.login || 'admin',
                            currentDevice.senha || 'admin'
                        );
                        const retryUrl = `http://${deviceHost}/get_configuration.fcgi?session=${newSession}`;
                        let retryResp;
                        try {
                            retryResp = await fetch(retryUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(monitorPayload)
                            });
                        } catch (err) {
                            const msg = (err && err.message || '').toLowerCase();
                            if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                                retryResp = await fetch('http://localhost:3001/proxy/fcgi', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        targetUrl: retryUrl,
                                        payload: monitorPayload,
                                        headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                                    })
                                });
                            } else {
                                throw err;
                            }
                        }
                        if (!retryResp.ok) {
                            const text = await retryResp.text();
                            throw new Error(text || `HTTP error! status: ${retryResp.status}`);
                        }
                        cfg = await retryResp.json();
                        if (cfg && cfg.error) {
                            throw new Error(cfg.error || 'Erro ao obter configura√ß√£o do monitor');
                        }
                    } else if (cfg.code === 1) {
                        console.warn('Sess√£o possivelmente inv√°lida (code=1); tentando renovar sess√£o...');
                        const newSession = await getDeviceSession(
                            deviceLoginAddr,
                            currentDevice.login || 'admin',
                            currentDevice.senha || 'admin'
                        );
                        const retryUrl = `http://${deviceHost}/get_configuration.fcgi?session=${newSession}`;
                        let retryResp;
                        try {
                            retryResp = await fetch(retryUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(monitorPayload)
                            });
                        } catch (err) {
                            const msg = (err && err.message || '').toLowerCase();
                            if (msg.includes('cors') || msg.includes('failed to fetch') || err.name === 'TypeError') {
                                retryResp = await fetch('http://localhost:3001/proxy/fcgi', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        targetUrl: retryUrl,
                                        payload: monitorPayload,
                                        headers: { 'contentType': 'application/json', 'Content-Type': 'application/json' }
                                    })
                                });
                            } else {
                                throw err;
                            }
                        }
                        if (!retryResp.ok) {
                            const text = await retryResp.text();
                            throw new Error(text || `HTTP error! status: ${retryResp.status}`);
                        }
                        cfg = await retryResp.json();
                        if (cfg && cfg.error) {
                            throw new Error(cfg.error || 'Erro ao obter configura√ß√£o do monitor');
                        }
                    } else {
                        throw new Error(cfg.error || 'Erro ao obter configura√ß√£o do monitor');
                    }
                }

                // Alguns firmwares retornam JSON aninhado: { monitor: { ... } }
                const monitorObj = cfg.monitor || cfg || {};
                // Sanitizar hostname (remover crases/espacos e protocolo)
                const rawHostname = (monitorObj.hostname != null ? String(monitorObj.hostname) : '').replace(/`/g, '').trim();
                const cleanHostname = rawHostname.replace(/^https?:\/\//, '');
                const hostname = cleanHostname || '-';
                const port = (monitorObj.port != null ? String(monitorObj.port) : '-');
                const path = monitorObj.path || '-';
                const timeout = (monitorObj.request_timeout != null ? String(monitorObj.request_timeout) + 'ms' : '-');
                const effectiveUrl = (cleanHostname ? `https://${cleanHostname}:${monitorObj.port || 443}${monitorObj.path || '/log'}` : '-');

                // Preencher UI com dados do dispositivo
                setText('monitorHostname', hostname);
                setText('monitorPortCurrent', port);
                setText('monitorPath', path);
                setText('monitorTimeoutCurrent', timeout);
                setText('monitorEffectiveUrl', effectiveUrl);

                console.log('‚úÖ [getMonitorConfig] Configura√ß√£o do monitor obtida e aplicada', {
                    hostname,
                    port,
                    path,
                    timeout,
                    effectiveUrl,
                    raw: cfg
                });

                // Atualizar inputs sugerindo os valores do equipamento
                const monitorUrlInput = document.getElementById('monitorUrl');
                const monitorTimeoutInput = document.getElementById('monitorTimeout');
                const monitorPortInput = document.getElementById('monitorPort');
                if (monitorUrlInput && (!monitorUrlInput.value || monitorUrlInput.value.trim() === '')) {
                    if (effectiveUrl && effectiveUrl !== '-') {
                        monitorUrlInput.value = effectiveUrl;
                    }
                }
                if (monitorTimeoutInput && cfg.request_timeout != null) {
                    monitorTimeoutInput.value = parseInt(cfg.request_timeout);
                }
                if (monitorPortInput && cfg.port != null) {
                    monitorPortInput.value = parseInt(cfg.port);
                }

            } catch (error) {
                console.warn('‚ö†Ô∏è [getMonitorConfig] Falha na chamada direta ao dispositivo. N√£o ser√° usada Lambda para este fluxo.', error);
                alert('‚ùå [getMonitorConfig] N√£o foi poss√≠vel obter a configura√ß√£o diretamente do dispositivo. Verifique se a porta configurada no dispositivo est√° acess√≠vel e se a sess√£o est√° v√°lida.');
            } finally {
                setButtonLoading(fetchBtn, false);
                console.log('üßπ [getMonitorConfig] Finalizado', { time: new Date().toISOString() });
            }
        }

        async function configureSync() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const configureBtn = document.getElementById('configureSyncBtn');
            setButtonLoading(configureBtn, true);

            try {
                const syncInterval = document.getElementById('syncInterval').value;
                const retryAttempts = document.getElementById('retryAttempts').value;

                console.log('üîÑ Configurando sincroniza√ß√£o:', { syncInterval, retryAttempts });

                const payload = {
                    action: 'configure_sync',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha,
                    sync_interval: parseInt(syncInterval),
                    retry_attempts: parseInt(retryAttempts)
                };

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì• Resposta da configura√ß√£o:', data);

                if (data.status === 'success') {
                    alert('‚úÖ Sincroniza√ß√£o configurada com sucesso!');
                } else {
                    throw new Error(data.message || 'Erro ao configurar sincroniza√ß√£o');
                }

            } catch (error) {
                console.error('‚ùå Erro ao configurar sincroniza√ß√£o:', error);
                alert('‚ùå Erro ao configurar sincroniza√ß√£o: ' + error.message);
            } finally {
                setButtonLoading(configureBtn, false);
            }
        }

        async function forceSync() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const syncBtn = document.getElementById('forceSyncBtn');
            setButtonLoading(syncBtn, true);

            try {
                console.log('üîÑ For√ßando sincroniza√ß√£o:', currentDevice);

                const payload = {
                    action: 'force_sync',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha
                };

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì• Resposta da sincroniza√ß√£o:', data);

                if (data.status === 'success') {
                    alert('‚úÖ Sincroniza√ß√£o for√ßada com sucesso!');
                } else {
                    throw new Error(data.message || 'Erro na sincroniza√ß√£o');
                }

            } catch (error) {
                console.error('‚ùå Erro ao for√ßar sincroniza√ß√£o:', error);
                alert('‚ùå Erro ao for√ßar sincroniza√ß√£o: ' + error.message);
            } finally {
                setButtonLoading(syncBtn, false);
            }
        }

        async function configureLogs() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const configureBtn = document.getElementById('configureLogsBtn');
            setButtonLoading(configureBtn, true);

            try {
                const logLevel = document.getElementById('logLevel').value;
                const logRetention = document.getElementById('logRetention').value;

                console.log('üìù Configurando logs:', { logLevel, logRetention });

                const payload = {
                    action: 'configure_logs',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha,
                    log_level: logLevel,
                    log_retention: parseInt(logRetention)
                };

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì• Resposta da configura√ß√£o:', data);

                if (data.status === 'success') {
                    alert('‚úÖ Logs configurados com sucesso!');
                } else {
                    throw new Error(data.message || 'Erro ao configurar logs');
                }

            } catch (error) {
                console.error('‚ùå Erro ao configurar logs:', error);
                alert('‚ùå Erro ao configurar logs: ' + error.message);
            } finally {
                setButtonLoading(configureBtn, false);
            }
        }

        async function downloadLogs() {
            if (!currentDevice) {
                alert('Nenhum dispositivo selecionado');
                return;
            }

            const downloadBtn = document.getElementById('downloadLogsBtn');
            setButtonLoading(downloadBtn, true);

            try {
                console.log('üì• Baixando logs:', currentDevice);

                const payload = {
                    action: 'download_logs',
                    device_ip: currentDevice.ip,
                    login: currentDevice.login,
                    password: currentDevice.senha
                };

                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üì• Resposta do download:', data);

                if (data.status === 'success' && data.data && data.data.logs) {
                    // Criar e baixar arquivo de log
                    const logContent = data.data.logs;
                    const blob = new Blob([logContent], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logs_${currentDevice.nome}_${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Logs baixados com sucesso!');
                } else {
                    throw new Error(data.message || 'Erro ao baixar logs');
                }

            } catch (error) {
                console.error('‚ùå Erro ao baixar logs:', error);
                alert('‚ùå Erro ao baixar logs: ' + error.message);
            } finally {
                setButtonLoading(downloadBtn, false);
            }
        }

        // Fun√ß√£o para abrir modal de edi√ß√£o de usu√°rio
        async function openUserEditModal(user) {
            console.log('üîß Abrindo modal de edi√ß√£o para usu√°rio:', user);
            
            // Criar modal se n√£o existir
            let modal = document.getElementById('userEditModal');
            if (!modal) {
                console.log('üìù Criando novo modal de edi√ß√£o');
                modal = createUserEditModal();
                document.body.appendChild(modal);
            }

            // Preencher dados do usu√°rio
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserRegistration').value = user.registration || '';
            document.getElementById('editUserPassword').value = user.password || '';

            // Carregar foto do usu√°rio
            const photoImg = document.getElementById('editUserPhoto');
            const photoPlaceholder = document.getElementById('editUserPhotoPlaceholder');
            
            try {
                const photoUrl = await loadUserPhoto(user.id);
                if (photoUrl) {
                    photoImg.src = photoUrl;
                    photoImg.style.display = 'block';
                    photoPlaceholder.style.display = 'none';
                } else {
                    photoImg.style.display = 'none';
                    photoPlaceholder.style.display = 'flex';
                }
            } catch (error) {
                console.warn('Erro ao carregar foto:', error);
                photoImg.style.display = 'none';
                photoPlaceholder.style.display = 'flex';
            }

            // Adicionar evento de clique no fundo para fechar
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeUserEditModal();
                }
            };

            // Mostrar modal
            console.log('üëÅÔ∏è Mostrando modal');
            modal.style.display = 'flex';
        }

        // Fun√ß√£o para criar modal de edi√ß√£o
        function createUserEditModal() {
            const modal = document.createElement('div');
            modal.id = 'userEditModal';
            modal.className = 'user-edit-modal';
            modal.style.display = 'none'; // Inicialmente oculto
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="close-btn" onclick="closeUserEditModal()">√ó</button>
                    <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">Editar Usu√°rio</h3>
                    
                    <form id="userEditForm">
                        <input type="hidden" id="editUserId">
                        
                        <!-- Foto -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Foto</label>
                            <div style="display: flex; justify-content: center;">
                                <div style="width: 120px; height: 120px; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer; overflow: hidden; position: relative;">
                                    <img id="editUserPhoto" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <div id="editUserPhotoPlaceholder" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #999;">
                                        üë§
                                    </div>
                                    <input type="file" id="editPhotoInput" accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nome -->
                        <div style="margin-bottom: 16px;">
                            <label for="editUserName" style="display: block; margin-bottom: 8px; font-weight: 500;">Nome</label>
                            <input type="text" id="editUserName" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <!-- Matr√≠cula -->
                        <div style="margin-bottom: 16px;">
                            <label for="editUserRegistration" style="display: block; margin-bottom: 8px; font-weight: 500;">Matr√≠cula</label>
                            <input type="text" id="editUserRegistration" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>

                        <!-- Senha -->
                        <div style="margin-bottom: 24px;">
                            <label for="editUserPassword" style="display: block; margin-bottom: 8px; font-weight: 500;">Senha</label>
                            <input type="password" id="editUserPassword" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <!-- Bot√µes de A√ß√£o -->
                        <div style="display: flex; justify-content: space-between; margin-top: 24px;">
                            <!-- Bot√£o Excluir -->
                            <div>
                                <button id="btnDeleteUser" type="button" style="padding: 12px 16px; background: #fee; color: #c33; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    üóëÔ∏è Excluir
                                </button>
                                <button id="btnConfirmDelete" type="button" style="display: none; padding: 12px 16px; background: #c33; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    ‚ö†Ô∏è Confirmar Exclus√£o
                                </button>
                            </div>
                            <!-- Bot√£o Salvar -->
                            <button type="submit" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                üíæ Salvar
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Configurar eventos
            setupUserEditModalEvents(modal);
            return modal;
        }

        // Fun√ß√£o para configurar eventos do modal
        function setupUserEditModalEvents(modal) {
            // Preview da foto
            const photoInput = modal.querySelector('#editPhotoInput');
            const photoImg = modal.querySelector('#editUserPhoto');
            const photoPlaceholder = modal.querySelector('#editUserPhotoPlaceholder');

            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoImg.src = e.target.result;
                        photoImg.style.display = 'block';
                        photoPlaceholder.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });

            // Formul√°rio de edi√ß√£o
            const form = modal.querySelector('#userEditForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveUserChanges();
            });

            // Bot√µes de exclus√£o
            const btnDelete = modal.querySelector('#btnDeleteUser');
            const btnConfirm = modal.querySelector('#btnConfirmDelete');

            btnDelete.addEventListener('click', function() {
                btnDelete.style.display = 'none';
                btnConfirm.style.display = 'inline-block';
                
                setTimeout(() => {
                    if (btnConfirm.style.display !== 'none') {
                        btnConfirm.style.display = 'none';
                        btnDelete.style.display = 'inline-block';
                    }
                }, 3000);
            });

            btnConfirm.addEventListener('click', async function() {
                await deleteUserFromDevice(
                    document.getElementById('editUserId').value,
                    document.getElementById('editUserName').value
                );
            });
        }

        // Fun√ß√£o para fechar modal
        function closeUserEditModal() {
            const modal = document.getElementById('userEditModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Fun√ß√£o para salvar altera√ß√µes do usu√°rio
        async function saveUserChanges() {
            const submitButton = document.querySelector('#userEditForm button[type="submit"]');
            
            try {
                submitButton.disabled = true;
                submitButton.textContent = '‚è≥ Salvando...';
                
                const userId = document.getElementById('editUserId').value;
                const name = document.getElementById('editUserName').value;
                const registration = document.getElementById('editUserRegistration').value;
                const password = document.getElementById('editUserPassword').value;
                const photoInput = document.getElementById('editPhotoInput');
                
                // Obter sess√£o do dispositivo
                const session = await getDeviceSession(
                    currentDevice.ip,
                    currentDevice.login || 'admin',
                    currentDevice.senha || 'admin'
                );
                
                // Atualizar dados do usu√°rio no dispositivo
                const payload = {
                    object: "users",
                    values: {
                        name: name,
                        registration: registration,
                        password: password
                    },
                    where: {
                        users: {
                            id: parseInt(userId)
                        }
                    }
                };

                console.log('Atualizando dados do usu√°rio:', payload);
                
                const response = await fetch(`http://${currentDevice.ip}/modify_objects.fcgi?session=${session}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erro ao atualizar dados:', errorText);
                    throw new Error('Erro ao atualizar usu√°rio no dispositivo');
                }

                // Se tem foto nova, enviar para o dispositivo
                if (photoInput.files.length > 0) {
                    const photoFile = photoInput.files[0];
                    const reader = new FileReader();
                    
                    await new Promise((resolve, reject) => {
                        reader.onload = async function(e) {
                            try {
                                const timestamp = Math.floor(Date.now() / 1000);
                                const url = `http://${currentDevice.ip}/user_set_image.fcgi?user_id=${userId}&timestamp=${timestamp}&match=0&session=${session}`;
                                
                                const uploadResponse = await fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/octet-stream'
                                    },
                                    body: new Uint8Array(e.target.result)
                                });
                                
                                const responseText = await uploadResponse.text();
                                let uploadData;
                                try {
                                    uploadData = JSON.parse(responseText);
                                } catch (e) {
                                    throw new Error(`Resposta inv√°lida do servidor: ${responseText}`);
                                }

                                if (!uploadResponse.ok) {
                                    throw new Error(`Erro ao fazer upload da imagem: ${uploadResponse.status} - ${responseText}`);
                                }
                                
                                if (uploadData.success === false) {
                                    const errorMessages = uploadData.errors.map(err => `${err.code}: ${err.message}`).join(', ');
                                    throw new Error(`Falha no cadastro da imagem: ${errorMessages}`);
                                }
                                
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = () => reject(new Error('Erro ao ler arquivo de imagem'));
                        reader.readAsArrayBuffer(photoFile);
                    });
                }
                
                alert('Usu√°rio atualizado com sucesso! As altera√ß√µes ser√£o vis√≠veis na pr√≥xima vez que a lista for carregada.');
                closeUserEditModal();
                
            } catch (error) {
                console.error('Erro ao atualizar usu√°rio:', error);
                alert('Erro ao atualizar usu√°rio: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'üíæ Salvar';
            }
        }

        // Fun√ß√£o para excluir usu√°rio do dispositivo
        async function deleteUserFromDevice(userId, userName) {
            try {
                const session = await getDeviceSession(
                    currentDevice.ip,
                    currentDevice.login || 'admin',
                    currentDevice.senha || 'admin'
                );

                const response = await fetch(`http://${currentDevice.ip}/destroy_objects.fcgi?session=${session}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        object: "users",
                        where: {
                            users: {
                                id: parseInt(userId)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Erro ao excluir usu√°rio');
                }

                alert('Usu√°rio exclu√≠do com sucesso! As altera√ß√µes ser√£o vis√≠veis na pr√≥xima vez que a lista for carregada.');
                closeUserEditModal();

            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                alert('Erro ao excluir usu√°rio: ' + error.message);
            }
        }

        // Fun√ß√£o para obter sess√£o do dispositivo
        async function getDeviceSession(ipAddress, login, password) {
            try {
                const ipAddressWithPort = ipAddress.includes(':') ? ipAddress : `${ipAddress}:80`;
                
                const response = await fetch(`http://${ipAddressWithPort}/login.fcgi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        login: login || 'admin',
                        password: password || 'admin'
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao obter sess√£o do dispositivo');
                }

                const data = await response.json();
                if (!data.session) {
                    throw new Error('Sess√£o n√£o retornada pelo dispositivo');
                }

                return data.session;
            } catch (error) {
                console.error('Erro ao obter sess√£o:', error);
                throw new Error('N√£o foi poss√≠vel conectar ao dispositivo. Verifique as credenciais e o IP.');
            }
        }

        // Fun√ß√£o para salvar dispositivo
        async function saveDispositivo() {
            const saveButton = document.querySelector('button[onclick="saveDispositivo()"]');
            
            try {
                // Mostrar loading no bot√£o
                setButtonLoading(saveButton, true);
                
                const form = document.getElementById('dispositivoForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    setButtonLoading(saveButton, false);
                    return;
                }

                const dispositivoData = {
                    nome: document.getElementById('nome').value,
                    ip: document.getElementById('ip').value,
                    escola_id: document.getElementById('escola_id').value || null,
                    status: document.getElementById('status').value || 'ATIVO',
                    login: document.getElementById('login').value,
                    senha: document.getElementById('senha').value,
                    device_id: document.getElementById('device_id').value || null,
                    monitor: document.getElementById('monitor').value || null,
                };

                console.log('üíæ Salvando dispositivo:', dispositivoData);
                console.log('üîë Supabase client config:', {
                    url: supabase.supabaseUrl,
                    key: supabase.supabaseKey ? 'Configurada' : 'N√£o configurada',
                    keyType: supabase.supabaseKey?.includes('eyJ') ? 'JWT Token' : 'Unknown'
                });

                let result;
                if (currentDispositivoId) {
                    console.log('üìù Atualizando dispositivo existente:', currentDispositivoId);
                    // Atualizar dispositivo existente
                    result = await supabase
                        .from('dispositivos')
                        .update(dispositivoData)
                        .eq('id', currentDispositivoId);
                } else {
                    console.log('‚ûï Criando novo dispositivo');
                    // Criar novo dispositivo
                    result = await supabase
                        .from('dispositivos')
                        .insert([dispositivoData]);
                }

                console.log('üìä Resultado da opera√ß√£o:', result);

                if (result.error) {
                    console.error('‚ùå Erro ao salvar dispositivo:', result.error);
                    console.error('üîç Detalhes do erro:', {
                        code: result.error.code,
                        message: result.error.message,
                        details: result.error.details,
                        hint: result.error.hint
                    });
                    alert('Erro ao salvar dispositivo: ' + result.error.message);
                    return;
                }

                console.log('‚úÖ Dispositivo salvo com sucesso!');
                alert('Dispositivo salvo com sucesso!');
                closeModal();
                loadDispositivos();

            } catch (error) {
                console.error('‚ùå Erro ao salvar dispositivo:', error);
                alert('Erro ao salvar dispositivo: ' + error.message);
            } finally {
                // Remover loading do bot√£o
                setButtonLoading(saveButton, false);
            }
        }

        // Fun√ß√£o para editar dispositivo
        function editDispositivo(dispositivoId) {
            openModal('edit', dispositivoId);
        }

        // Fun√ß√£o para excluir dispositivo
        async function deleteDispositivo(dispositivoId, dispositivoName) {
            if (!confirm(`Tem certeza que deseja excluir o dispositivo "${dispositivoName}"?\n\nAten√ß√£o: Esta a√ß√£o tamb√©m afetar√° todos os alunos vinculados a este dispositivo.`)) {
                return;
            }

            try {
                console.log('üóëÔ∏è Excluindo dispositivo:', { dispositivoId, dispositivoName });
                console.log('üîë Supabase client config:', {
                    url: supabase.supabaseUrl,
                    key: supabase.supabaseKey ? 'Configurada' : 'N√£o configurada',
                    keyType: supabase.supabaseKey?.includes('eyJ') ? 'JWT Token' : 'Unknown'
                });

                const { data, error } = await supabase
                    .from('dispositivos')
                    .update({ soft_delete: new Date().toISOString() })
                    .eq('id', dispositivoId);

                console.log('üìä Resultado da exclus√£o:', { data, error });

                if (error) {
                    console.error('‚ùå Erro ao excluir dispositivo:', error);
                    console.error('üîç Detalhes do erro:', {
                        code: error.code,
                        message: error.message,
                        details: error.details,
                        hint: error.hint
                    });
                    alert('Erro ao excluir dispositivo: ' + error.message);
                    return;
                }

                console.log('‚úÖ Dispositivo exclu√≠do com sucesso!');
                alert('Dispositivo exclu√≠do com sucesso!');
                loadDispositivos();

            } catch (error) {
                console.error('‚ùå Erro ao excluir dispositivo:', error);
                alert('Erro ao excluir dispositivo: ' + error.message);
            }
        }

        // Dropdown menu functions
        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('dispositivoModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Logout function
        function logout() {
            redirectToLogin();
        }

        // Fun√ß√£o para testar conex√£o com Supabase
        async function testSupabaseConnection() {
            try {
                console.log('üîç Testando conex√£o com Supabase...');
                
                // Teste b√°sico de conex√£o com dispositivos
                const { data, error } = await supabase
                    .from('dispositivos')
                    .select('id, nome')
                    .is('soft_delete', null)
                    .limit(1);
                
                if (error) {
                    console.error('‚ùå Erro na conex√£o:', error);
                    return false;
                }
                
                console.log('‚úÖ Conex√£o com Supabase OK');
                console.log('üìä Dados de teste:', data);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao testar conex√£o:', error);
                return false;
            }
        }

        // Fun√ß√£o para verificar autentica√ß√£o
        async function checkAuthentication() {
            try {
                // Verificar se h√° usu√°rio logado via WhatsApp
                const whatsappUser = localStorage.getItem('whatsapp_user');
                
                if (!whatsappUser) {
                    console.log('‚ùå Usu√°rio n√£o autenticado via WhatsApp');
                    redirectToLogin();
                    return false;
                }
                
                const user = JSON.parse(whatsappUser);
                console.log('‚úÖ Usu√°rio autenticado via WhatsApp:', user);
                console.log('üìä Dados do usu√°rio:', {
                    nome: user.nome,
                    tipo_usuario: user.tipo_usuario,
                    status: user.status,
                    whatsapp: user.whatsapp
                });
                
                // Verificar se o usu√°rio √© admin
                if (user.tipo_usuario !== 'admin') {
                    console.log('‚ùå Usu√°rio n√£o √© administrador:', user.tipo_usuario);
                    alert('Acesso negado. Apenas administradores podem acessar esta √°rea.');
                    redirectToLogin();
                    return false;
                }
                
                // Verificar status - ser mais flex√≠vel
                if (user.status && user.status !== 'ativo') {
                    console.log('‚ùå Usu√°rio inativo:', user.status);
                    alert('Sua conta est√° inativa. Entre em contato com o administrador.');
                    redirectToLogin();
                    return false;
                }
                
                console.log('‚úÖ Usu√°rio autorizado:', user.nome);
                return true;
                
            } catch (error) {
                console.error('Erro na verifica√ß√£o de autentica√ß√£o:', error);
                redirectToLogin();
                return false;
            }
        }
        
        // Fun√ß√£o para redirecionar para login
        function redirectToLogin() {
            // Limpar dados de sess√£o
            localStorage.removeItem('authToken');
            localStorage.removeItem('userSession');
            localStorage.removeItem('whatsapp_user');
            sessionStorage.clear();
            
            // Redirecionar para login
            window.location.href = '../login.html';
        }
        
        // Inicializar aplica√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Inicializando aplica√ß√£o de dispositivos...');
            
            try {
                await initializeSupabase();
                
                // Verificar autentica√ß√£o e autoriza√ß√£o
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    return;
                }
                
                // Testar conex√£o
                const connectionOk = await testSupabaseConnection();
                if (!connectionOk) {
                    showEmptyState('Erro de conex√£o com o banco de dados');
                    return;
                }
                
                // Carregar dados iniciais
                await Promise.all([
                    loadSchools(),
                    loadDispositivos()
                ]);
                
                console.log('Aplica√ß√£o inicializada com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar aplica√ß√£o:', error);
                showEmptyState('Erro ao carregar dados');
            }
        });

        // ========== FUN√á√ïES DA ABA DE UPLOAD EM MASSA ==========

        let uploadEscolas = [];
        let uploadSeries = [];
        let uploadTurmas = [];
        let uploadAlunos = [];
        let uploadLambdaUrl = ''; // URL ser√° fornecida pelo usu√°rio

        // Carregar escolas para upload
        async function loadEscolasForUpload() {
            try {
                const { data, error } = await supabase
                    .from('escolas')
                    .select('id, nome')
                    .order('nome');

                if (error) throw error;

                uploadEscolas = data || [];
                populateUploadSelect('uploadEscola', uploadEscolas, 'nome');
            } catch (error) {
                console.error('Erro ao carregar escolas:', error);
                showToast('Erro ao carregar escolas', 'error');
            }
        }

        // Carregar s√©ries para upload
        async function loadSeriesForUpload() {
            try {
                const { data, error } = await supabase
                    .from('series')
                    .select('id, nome')
                    .order('nome');

                if (error) throw error;

                uploadSeries = data || [];
                populateUploadSelect('uploadSerie', uploadSeries, 'nome');
            } catch (error) {
                console.error('Erro ao carregar s√©ries:', error);
                showToast('Erro ao carregar s√©ries', 'error');
            }
        }

        // Carregar turmas baseado na escola e s√©rie selecionadas
        async function loadTurmasForUpload() {
            const escolaId = document.getElementById('uploadEscola').value;
            const serieId = document.getElementById('uploadSerie').value;

            if (!escolaId) {
                document.getElementById('uploadTurma').innerHTML = '<option value="">Selecione uma turma</option>';
                document.getElementById('alunosPreview').innerHTML = '<p class="text-gray-500">Selecione uma escola para visualizar os alunos</p>';
                document.getElementById('uploadBtn').disabled = true;
                return;
            }

            await loadAlunosByEscolaAndSerie(escolaId, serieId);

            if (!serieId) {
                document.getElementById('uploadTurma').innerHTML = '<option value="">Selecione uma turma</option>';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('turmas')
                    .select('id, nome')
                    .eq('escola_id', escolaId)
                    .eq('serie_id', serieId)
                    .order('nome');

                if (error) throw error;

                uploadTurmas = data || [];
                populateUploadSelect('uploadTurma', uploadTurmas, 'nome');
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                showToast('Erro ao carregar turmas', 'error');
            }
        }

        // Carregar alunos da turma selecionada
        async function loadAlunosForUpload() {
            const turmaId = document.getElementById('uploadTurma').value;

            if (!turmaId) {
                document.getElementById('alunosPreview').innerHTML = '<p class="text-gray-500">Selecione uma turma para visualizar os alunos</p>';
                document.getElementById('uploadBtn').disabled = true;
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('alunos')
                    .select('id, nome, matricula, foto_url, id_control_id')
                    .eq('turma_id', turmaId)
                    .order('nome');

                if (error) throw error;

                uploadAlunos = (data || []).map(a => ({ ...a, selected: true }));
                filterUploadAlunos();
                document.getElementById('uploadBtn').disabled = uploadAlunos.length === 0;
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                showToast('Erro ao carregar alunos', 'error');
            }
        }

        async function loadAlunosByEscolaAndSerie(escolaId, serieId) {
            try {
                let query = supabase
                    .from('turmas')
                    .select('id, serie_id')
                    .eq('escola_id', escolaId)
                    .order('nome');

                if (serieId) {
                    query = query.eq('serie_id', serieId);
                }

                const { data: turmas, error: turmasError } = await query;
                if (turmasError) throw turmasError;

                const turmaIds = (turmas || []).map(t => t.id);
                if (!turmaIds || turmaIds.length === 0) {
                    document.getElementById('alunosPreview').innerHTML = '<p class="text-gray-500">Nenhuma turma encontrada para esta sele√ß√£o</p>';
                    document.getElementById('uploadBtn').disabled = true;
                    return;
                }

                const { data: alunos, error: alunosError } = await supabase
                    .from('alunos')
                    .select('id, nome, matricula, foto_url, id_control_id, turma_id')
                    .in('turma_id', turmaIds)
                    .order('nome');

                if (alunosError) throw alunosError;

                uploadAlunos = (alunos || []).map(a => ({ ...a, selected: true }));
                filterUploadAlunos();
                document.getElementById('uploadBtn').disabled = uploadAlunos.length === 0;
            } catch (error) {
                console.error('Erro ao carregar alunos por escola:', error);
                showToast('Erro ao carregar alunos por escola', 'error');
            }
        }

        // Popular select com dados
        function populateUploadSelect(selectId, data, textField) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            select.innerHTML = `<option value="">Selecione uma ${selectId.replace('upload', '').toLowerCase()}</option>`;
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[textField];
                if (item.id == currentValue) option.selected = true;
                select.appendChild(option);
            });
        }

        // Renderizar preview dos alunos
        function renderAlunosPreview(alunos) {
            const container = document.getElementById('alunosPreview');
            
            if (alunos.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhum aluno encontrado nesta turma</p>';
                return;
            }

            const html = alunos.map(aluno => `
                <div class="aluno-item">
                    <label class="aluno-select" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" ${aluno.selected ? 'checked' : ''} onchange="toggleAlunoSelection('${aluno.id}', this.checked)">
                        <div class="aluno-info">
                            <div class="aluno-name">${aluno.nome}</div>
                            <div class="aluno-id">ID: ${aluno.id} | Matr√≠cula: ${aluno.matricula || 'N/A'}</div>
                        </div>
                    </label>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function toggleAlunoSelection(alunoId, checked) {
            const idx = uploadAlunos.findIndex(a => a.id === alunoId);
            if (idx >= 0) {
                uploadAlunos[idx].selected = checked;
            }
        }

        function markAllAlunos() {
            uploadAlunos = uploadAlunos.map(a => ({ ...a, selected: true }));
            renderAlunosPreview(uploadAlunos);
        }

        function unmarkAllAlunos() {
            uploadAlunos = uploadAlunos.map(a => ({ ...a, selected: false }));
            renderAlunosPreview(uploadAlunos);
        }

        function filterUploadAlunos() {
            const input = document.getElementById('uploadAlunosSearch');
            const q = (input ? input.value : '').toLowerCase().trim();
            if (!q) {
                renderAlunosPreview(uploadAlunos);
                return;
            }
            const filtered = uploadAlunos.filter(a => {
                const nome = (a.nome || '').toLowerCase();
                const matricula = ((a.matricula || '') + '').toLowerCase();
                const controlId = ((a.id_control_id || '') + '').toLowerCase();
                return nome.includes(q) || matricula.includes(q) || controlId.includes(q);
            });
            renderAlunosPreview(filtered);
        }

        // Fun√ß√£o principal de upload
        async function uploadAlunosToDevice() {
            if (!currentDevice) {
                showToast('Nenhum dispositivo selecionado', 'error');
                return;
            }

            if (uploadAlunos.length === 0) {
                showToast('Nenhum aluno selecionado para upload', 'error');
                return;
            }

            // Verificar modo direto vs Lambda
            const directMode = document.getElementById('uploadDirectMode').checked;
            if (!directMode && !uploadLambdaUrl) {
                showToast('URL da fun√ß√£o Lambda n√£o configurada', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('uploadProgress');
            const resultsContainer = document.getElementById('uploadResults');
            
            // Preparar interface
            uploadBtn.disabled = true;
            progressContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            try {
                const password = document.getElementById('uploadPassword').value || '123456';
                const groupId = parseInt(document.getElementById('uploadGroupId').value) || 1;
                
                const results = [];
                let successCount = 0;
                let errorCount = 0;

                const selectedAlunos = uploadAlunos.filter(a => a.selected);
                if (selectedAlunos.length === 0) {
                    showToast('Nenhum aluno marcado para upload', 'warning');
                    return;
                }
                progressText.textContent = `Enviando ${selectedAlunos.length} alunos...`;
                
                for (let i = 0; i < selectedAlunos.length; i++) {
                    const aluno = selectedAlunos[i];
                    const progress = ((i + 1) / selectedAlunos.length) * 100;
                    
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `Enviando ${aluno.nome} (${i + 1}/${selectedAlunos.length})`;
                    
                    try {
                        const result = directMode
                            ? await uploadSingleStudentDirect(aluno, currentDevice, password, groupId)
                            : await uploadSingleStudent(aluno, currentDevice, password, groupId);
                        results.push({
                            aluno: aluno.nome,
                            status: 'success',
                            message: 'Enviado com sucesso'
                        });
                        successCount++;
                    } catch (error) {
                        results.push({
                            aluno: aluno.nome,
                            status: 'error',
                            message: error.message
                        });
                        errorCount++;
                    }
                    
                    // Pequena pausa entre uploads
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Mostrar resultados
                showUploadResults(results, successCount, errorCount);
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showToast('Erro durante o upload: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        // Fun√ß√£o para verificar e criar v√≠nculo aluno_dispositivo se n√£o existir
        async function checkAndCreateAlunoDispositivo(alunoId, dispositivoId) {
            try {
                console.log('üîç Verificando v√≠nculo aluno_dispositivo:', { alunoId, dispositivoId });
                
                // Buscar dados completos do aluno para obter o id_control_id
                const { data: alunoData, error: alunoError } = await supabase
                    .from('alunos')
                    .select('id_control_id')
                    .eq('id', alunoId)
                    .single();

                if (alunoError) {
                    console.error('‚ùå Erro ao buscar dados do aluno:', alunoError);
                    throw new Error('Erro ao buscar dados do aluno: ' + alunoError.message);
                }

                if (!alunoData.id_control_id) {
                    throw new Error(`Aluno ID ${alunoId} n√£o possui ID Control-ID. √â necess√°rio ter um ID de 8 d√≠gitos para vincular ao dispositivo.`);
                }
                
                // Verificar se j√° existe o v√≠nculo
                const { data: existingRel, error: existError } = await supabase
                    .from('aluno_dispositivo')
                    .select('id')
                    .eq('aluno', alunoId)
                    .eq('id_dispositivo', dispositivoId)
                    .limit(1);

                if (existError) {
                    console.error('‚ùå Erro ao verificar v√≠nculo aluno_dispositivo:', existError);
                    throw new Error('Erro ao verificar v√≠nculo aluno-dispositivo: ' + existError.message);
                }

                if (existingRel && existingRel.length > 0) {
                    console.log('‚úÖ V√≠nculo aluno_dispositivo j√° existe, n√£o criando duplicata');
                    return;
                }

                // Obter dados do usu√°rio logado
                const whatsappUser = JSON.parse(localStorage.getItem('whatsapp_user') || '{}');
                
                // Obter escola do dispositivo atual
                let escolaId = null;
                if (currentDevice && currentDevice.escola_id) {
                    escolaId = currentDevice.escola_id;
                } else {
                    // Buscar escola do dispositivo
                    const { data: deviceData, error: deviceError } = await supabase
                        .from('dispositivos')
                        .select('escola_id')
                        .eq('id', dispositivoId)
                        .single();
                    
                    if (!deviceError && deviceData) {
                        escolaId = deviceData.escola_id;
                    }
                }

                // Criar o v√≠nculo
                const { error: insertError } = await supabase
                    .from('aluno_dispositivo')
                    .insert([{
                        id_dispositivo: dispositivoId,
                        aluno: alunoId,
                        escola: escolaId,
                        id_do_aluno_no_dispositivo: alunoData.id_control_id.toString(), // Usar id_control_id de 8 d√≠gitos
                        numero_de_quem_cadastrou: whatsappUser.whatsapp || 'UPLOAD_MASSA'
                    }]);

                if (insertError) {
                    console.error('‚ùå Erro ao criar v√≠nculo aluno_dispositivo:', insertError);
                    if (String(insertError.message || '').toLowerCase().includes('permission')) {
                        throw new Error('Permiss√£o negada ao criar v√≠nculo aluno-dispositivo. Confirme que o usu√°rio logado √© "admin" e est√° ativo.');
                    } else {
                        throw new Error('Erro ao criar v√≠nculo aluno-dispositivo: ' + insertError.message);
                    }
                }

                console.log('‚úÖ V√≠nculo aluno_dispositivo criado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o/cria√ß√£o do v√≠nculo aluno_dispositivo:', error);
                // N√£o interromper o upload por erro de v√≠nculo, apenas logar
                console.warn('‚ö†Ô∏è Continuando upload mesmo com erro no v√≠nculo aluno_dispositivo');
            }
        }

        // Upload de um √∫nico aluno
        async function uploadSingleStudent(aluno, device, password, groupId) {
            // Verificar se j√° existe v√≠nculo aluno_dispositivo
            await checkAndCreateAlunoDispositivo(aluno.id, device.id);

            // Verificar se o aluno tem id_control_id
            if (!aluno.id_control_id) {
                throw new Error(`Aluno ${aluno.nome} n√£o possui ID Control-ID. √â necess√°rio ter um ID de 8 d√≠gitos para cadastrar no dispositivo.`);
            }

            const payload = {
                action: 'upload_student',
                device: {
                    ip: device.ip,
                    login: device.login,
                    password: device.senha
                },
                student: {
                    id: aluno.id_control_id, // Usando id_control_id de 8 d√≠gitos como ID no dispositivo
                    name: aluno.nome,
                    registration: aluno.id.toString(), // Mantendo ID do Supabase como matr√≠cula
                    password: password
                },
                groupId: groupId
            };

            const response = await fetch(uploadLambdaUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const result = await response.json();

            // Compatibilidade: aceita tanto { success: true } quanto { status: 'success' }
            const ok = (result && (result.success === true || result.status === 'success'));
            if (!ok) {
                throw new Error(result.message || result.error || 'Erro desconhecido');
            }

            return result;
        }

        // Upload direto de um √∫nico aluno (HTTP no dispositivo)
        async function uploadSingleStudentDirect(aluno, device, password, groupId) {
            // Verificar se o aluno tem id_control_id
            if (!aluno.id_control_id) {
                throw new Error(`Aluno ${aluno.nome} n√£o possui ID Control-ID. √â necess√°rio ter um ID de 8 d√≠gitos para cadastrar no dispositivo.`);
            }

            // 1) Obter sess√£o
            const session = await getDeviceSession(
                device.ip,
                device.login || 'admin',
                device.senha || 'admin'
            );

            const deviceIp = device.ip.includes(':') ? device.ip : `${device.ip}:80`;
            const baseUrl = `http://${deviceIp}`;
            console.log('[UploadDireto] Sess√£o obtida:', { session, deviceIp });

            // 1.1) Verificar exist√™ncia por id_control_id (ID do dispositivo) e registration (ID do Supabase)
            const deviceUserId = String(aluno.id_control_id); // ID de 8 d√≠gitos para o dispositivo
            const registrationId = (aluno.id != null ? String(aluno.id) : ''); // ID do Supabase para matr√≠cula
            const keysToCheck = [registrationId];
            console.log('[UploadDireto] Verifica√ß√£o:', { deviceUserId, registrationId });

            // Helpers locais: carregar e excluir por registration
            async function loadUsersByRegistration(reg) {
                const payload = {
                    object: 'users',
                    where: { users: { registration: reg } }
                };
                const resp = await fetch(`${baseUrl}/load_objects.fcgi?session=${session}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const text = await resp.text();
                let data = {};
                try { data = JSON.parse(text); } catch { console.warn('load_users resposta n√£o-JSON:', text); }
                if (!resp.ok) throw new Error(`Falha ao carregar usu√°rios (${resp.status}): ${text}`);
                return Array.isArray(data.users) ? data.users : [];
            }

            async function destroyUsersByRegistration(reg) {
                const payload = {
                    object: 'users',
                    where: { users: { registration: reg } }
                };
                const resp = await fetch(`${baseUrl}/destroy_objects.fcgi?session=${session}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const text = await resp.text();
                let data = {};
                try { data = JSON.parse(text); } catch { console.warn('destroy_users resposta n√£o-JSON:', text); }
                if (!resp.ok) throw new Error(`Falha ao excluir usu√°rios (${resp.status}): ${text}`);
                return data;
            }

            // 1.2) Checar exist√™ncia e excluir antes de recriar
            try {
                const existingMatches = [];
                for (const key of keysToCheck) {
                    if (!key) continue;
                    console.log('[UploadDireto] Verificando exist√™ncia por registration:', key);
                    const users = await loadUsersByRegistration(key);
                    if (users.length > 0) {
                        console.log(`[UploadDireto] Encontrados ${users.length} usu√°rio(s) com registration=${key}. Excluindo...`);
                        await destroyUsersByRegistration(key);
                        existingMatches.push(key);
                    }
                }
                if (existingMatches.length > 0) {
                    showToast(`Usu√°rio existente removido (${existingMatches.join(', ')}). Recriando com dados do Supabase.`, 'info');
                }
            } catch (preErr) {
                console.warn('[UploadDireto] Aviso ao conciliar antes de criar:', preErr);
            }

            // 2) Criar usu√°rio usando id_control_id como ID do dispositivo e ID do Supabase como registration
            const registrationValue = (aluno.id != null ? String(aluno.id) : '');
            console.log('[UploadDireto] Criando usu√°rio no dispositivo:', {
                id: deviceUserId,
                name: aluno.nome,
                registration: registrationValue,
                password
            });
            const createUserResp = await fetch(`${baseUrl}/create_objects.fcgi?session=${session}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    object: 'users',
                    values: [{
                        id: parseInt(deviceUserId), // Usando id_control_id de 8 d√≠gitos como ID do dispositivo
                        name: aluno.nome,
                        registration: registrationValue, // Mantendo ID do Supabase como matr√≠cula
                        password: password,
                        salt: ''
                    }]
                })
            });

            if (!createUserResp.ok) {
                const t = await createUserResp.text();
                throw new Error(t || `Erro ao criar usu√°rio: ${createUserResp.status}`);
            }

            const createData = await createUserResp.json();
            console.log('[UploadDireto] create_objects resposta:', createData);
            // Usar o id_control_id como ID do usu√°rio no dispositivo
            const userDeviceId = parseInt(deviceUserId);

            // 3) Adicionar ao grupo
            console.log('[UploadDireto] Associando usu√°rio ao grupo:', { userDeviceId: userDeviceId, groupId: (groupId || 1) });
            const groupResp = await fetch(`${baseUrl}/create_objects.fcgi?session=${session}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    object: 'user_groups',
                    values: [{
                        user_id: userDeviceId,
                        group_id: groupId || 1
                    }]
                })
            });

            if (!groupResp.ok) {
                const t = await groupResp.text();
                throw new Error(t || `Erro ao adicionar usu√°rio ao grupo: ${groupResp.status}`);
            }

            // 3.1) Se houver foto do aluno, enviar para o dispositivo
            const imageUserId = userDeviceId; // Usar id_control_id como ID do usu√°rio no dispositivo
            console.log('[UploadDireto] Preparando envio de foto:', { foto_url: aluno.foto_url, imageUserId, userDeviceId });
            
            // 3.1) Se houver foto do aluno, enviar para o dispositivo
            try {
                if (aluno.foto_url) {
                    const imgResp = await fetch(aluno.foto_url);
                    if (!imgResp.ok) {
                        const t = await imgResp.text();
                        throw new Error(t || `Erro ao buscar foto do aluno: ${imgResp.status}`);
                    }

                    const originalBlob = await imgResp.blob();
                    console.log('[UploadDireto] Foto acess√≠vel. Tamanho original (bytes):', originalBlob.size);
                    const processedBlob = await preprocessImage(originalBlob);
                    console.log('[UploadDireto] Foto processada. Tamanho (bytes):', processedBlob && processedBlob.size);
                    const arrayBuffer = await processedBlob.arrayBuffer();
                    const timestamp = Math.floor(Date.now() / 1000);
                    const imageUrl = `${baseUrl}/user_set_image.fcgi?user_id=${imageUserId}&timestamp=${timestamp}&match=0&session=${session}`;
                    console.log('[UploadDireto] Enviando foto para endpoint:', imageUrl);

                    const uploadResponse = await fetch(imageUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/octet-stream' },
                        body: new Uint8Array(arrayBuffer)
                    });

                    const responseText = await uploadResponse.text();
                    console.log('[UploadDireto] Resposta do upload de foto:', { status: uploadResponse.status, responseText });
                    let uploadData;
                    try {
                        uploadData = JSON.parse(responseText);
                    } catch (_) {
                        throw new Error(`Resposta inv√°lida ao enviar foto: ${responseText}`);
                    }
                    if (!uploadResponse.ok || uploadData.success === false) {
                        const errors = uploadData && uploadData.errors ? uploadData.errors.map(e => `${e.code}: ${e.message}`).join(', ') : responseText;
                        throw new Error(`Falha no upload da foto: ${errors}`);
                    }
                    console.log('[UploadDireto] Foto enviada com sucesso para o dispositivo');
                }
            } catch (photoErr) {
                console.warn('Aviso: falha ao enviar foto do aluno:', photoErr);
            }

            // 4) Verificar e criar v√≠nculo aluno_dispositivo
            await checkAndCreateAlunoDispositivo(aluno.id, device.id);

            // 5) Logout (best-effort)
            try {
                await fetch(`${baseUrl}/logout.fcgi?session=${session}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                console.log('[UploadDireto] Logout realizado com sucesso');
            } catch (_) {}

            return {
                success: true,
                message: `Usu√°rio ${aluno.nome} criado e associado ao grupo ${groupId}. Foto enviada (user_id=${userDeviceId})`,
                ids: userDeviceId ? [userDeviceId] : []
            };
        }

        // Helper: preprocessar imagem para formato aceito pelo dispositivo
        async function preprocessImage(imageBlob) {
            const imgBitmap = await createImageBitmap(imageBlob);
            const targetW = 480;
            const targetH = 640;
            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');

            // Fundo branco
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, targetW, targetH);

            // Ajustes leves para melhorar visibilidade
            try {
                ctx.filter = 'contrast(1.1) saturate(1.05) brightness(1.02)';
            } catch (_) {}

            // Centralizar mantendo propor√ß√£o
            const ratio = Math.min(targetW / imgBitmap.width, targetH / imgBitmap.height);
            const newW = Math.max(1, Math.floor(imgBitmap.width * ratio));
            const newH = Math.max(1, Math.floor(imgBitmap.height * ratio));
            const x = Math.floor((targetW - newW) / 2);
            const y = Math.floor((targetH - newH) / 2);
            ctx.drawImage(imgBitmap, x, y, newW, newH);

            // Converter para JPEG
            const processedBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
            return processedBlob || imageBlob;
        }

        // Mostrar resultados do upload
        function showUploadResults(results, successCount, errorCount) {
            const container = document.getElementById('uploadResults');
            const content = document.getElementById('resultsContent');
            
            const summaryHtml = `
                <div class="result-summary">
                    <p><strong>Resumo do Upload:</strong></p>
                    <p class="result-success">‚úÖ Sucessos: ${successCount}</p>
                    <p class="result-error">‚ùå Erros: ${errorCount}</p>
                </div>
                <div class="result-details">
                    ${results.map(result => `
                        <div class="result-item ${result.status === 'success' ? 'result-success' : 'result-error'}">
                            ${result.status === 'success' ? '‚úÖ' : '‚ùå'} ${result.aluno}: ${result.message}
                        </div>
                    `).join('')}
                </div>
            `;
            
            content.innerHTML = summaryHtml;
            container.style.display = 'block';
        }

        // Notifica√ß√£o simples na tela
        function showToast(message, type = 'info') {
            const existing = document.getElementById('toastContainer');
            const container = existing || (() => {
                const c = document.createElement('div');
                c.id = 'toastContainer';
                c.style.position = 'fixed';
                c.style.bottom = '16px';
                c.style.right = '16px';
                c.style.zIndex = '9999';
                c.style.display = 'flex';
                c.style.flexDirection = 'column';
                c.style.gap = '8px';
                document.body.appendChild(c);
                return c;
            })();

            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.padding = '10px 14px';
            toast.style.borderRadius = '6px';
            toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            toast.style.color = '#fff';
            toast.style.fontSize = '14px';
            toast.style.maxWidth = '420px';
            toast.style.wordBreak = 'break-word';

            const bg = type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : type === 'success' ? '#10b981' : '#3b82f6';
            toast.style.background = bg;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
            }, 0);

            setTimeout(() => {
                toast.style.transition = 'opacity 300ms ease';
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 320);
            }, 3500);
        }

        // Limpar formul√°rio de upload
        function clearUploadForm() {
            document.getElementById('uploadEscola').value = '';
            document.getElementById('uploadSerie').value = '';
            document.getElementById('uploadTurma').value = '';
            document.getElementById('lambdaUrl').value = '';
            document.getElementById('uploadPassword').value = '123456';
            document.getElementById('uploadGroupId').value = '1';
            document.getElementById('alunosPreview').innerHTML = '<p class="text-gray-500">Selecione uma turma para visualizar os alunos</p>';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadResults').style.display = 'none';
            const search = document.getElementById('uploadAlunosSearch');
            if (search) search.value = '';
            
            uploadAlunos = [];
            uploadLambdaUrl = '';
        }

        // Configurar URL da Lambda (ser√° chamada quando o usu√°rio fornecer)
        function setUploadLambdaUrl(url) {
            uploadLambdaUrl = url;
            console.log('URL da Lambda configurada:', url);
        }

        // Configurar URL da Lambda automaticamente
        function initializeLambdaUrl() {
        const defaultLambdaUrl = 'https://yfh5dmsuucx76bronca7f7k3le0sjykd.lambda-url.us-east-2.on.aws/';
            uploadLambdaUrl = defaultLambdaUrl;
            document.getElementById('lambdaUrl').value = defaultLambdaUrl;
            console.log('URL da Lambda configurada automaticamente:', defaultLambdaUrl);
        }

        // Inicializar dados da aba de upload quando ela for aberta
        function initializeUploadTab() {
            // Configurar URL da Lambda automaticamente
            initializeLambdaUrl();
            
            if (uploadEscolas.length === 0) {
                loadEscolasForUpload();
            }
            if (uploadSeries.length === 0) {
                loadSeriesForUpload();
            }
        }

        // Modificar a fun√ß√£o switchTab para inicializar a aba de upload
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            
            if (tabName === 'upload') {
                initializeUploadTab();
            }
        };
    </script>
    
    <!-- PWA Scripts -->
    <link rel="stylesheet" href="../css/pwa-styles.css">
    <script src="../js/pwa.js"></script>
    
    <!-- PWA Status Bar -->
    <div class="pwa-status-bar"></div>
</body>
</html>


